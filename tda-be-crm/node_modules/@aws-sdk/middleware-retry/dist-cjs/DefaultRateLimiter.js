"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DefaultRateLimiter = void 0;
const service_error_classification_1 = require("@aws-sdk/service-error-classification");
class DefaultRateLimiter {
    constructor(options) {
        var _a, _b, _c, _d, _e;
        this.currentCapacity = 0;
        this.enabled = false;
        this.lastMaxRate = 0;
        this.measuredTxRate = 0;
        this.requestCount = 0;
        this.lastTimestamp = 0;
        this.timeWindow = 0;
        this.beta = (_a = options === null || options === void 0 ? void 0 : options.beta) !== null && _a !== void 0 ? _a : 0.7;
        this.minCapacity = (_b = options === null || options === void 0 ? void 0 : options.minCapacity) !== null && _b !== void 0 ? _b : 1;
        this.minFillRate = (_c = options === null || options === void 0 ? void 0 : options.minFillRate) !== null && _c !== void 0 ? _c : 0.5;
        this.scaleConstant = (_d = options === null || options === void 0 ? void 0 : options.scaleConstant) !== null && _d !== void 0 ? _d : 0.4;
        this.smooth = (_e = options === null || options === void 0 ? void 0 : options.smooth) !== null && _e !== void 0 ? _e : 0.8;
        const currentTimeInSeconds = this.getCurrentTimeInSeconds();
        this.lastThrottleTime = currentTimeInSeconds;
        this.lastTxRateBucket = Math.floor(this.getCurrentTimeInSeconds());
        this.fillRate = this.minFillRate;
        this.maxCapacity = this.minCapacity;
    }
    getCurrentTimeInSeconds() {
        return Date.now() / 1000;
    }
    async getSendToken() {
        return this.acquireTokenBucket(1);
    }
    async acquireTokenBucket(amount) {
        if (!this.enabled) {
            return;
        }
        this.refillTokenBucket();
        if (amount > this.currentCapacity) {
            const delay = ((amount - this.currentCapacity) / this.fillRate) * 1000;
            await new Promise((resolve) => setTimeout(resolve, delay));
        }
        this.currentCapacity = this.currentCapacity - amount;
    }
    refillTokenBucket() {
        const timestamp = this.getCurrentTimeInSeconds();
        if (!this.lastTimestamp) {
            this.lastTimestamp = timestamp;
            return;
        }
        const fillAmount = (timestamp - this.lastTimestamp) * this.fillRate;
        this.currentCapacity = Math.min(this.maxCapacity, this.currentCapacity + fillAmount);
        this.lastTimestamp = timestamp;
    }
    updateClientSendingRate(response) {
        let calculatedRate;
        this.updateMeasuredRate();
        if (service_error_classification_1.isThrottlingError(response)) {
            const rateToUse = !this.enabled ? this.measuredTxRate : Math.min(this.measuredTxRate, this.fillRate);
            this.lastMaxRate = rateToUse;
            this.calculateTimeWindow();
            this.lastThrottleTime = this.getCurrentTimeInSeconds();
            calculatedRate = this.cubicThrottle(rateToUse);
            this.enableTokenBucket();
        }
        else {
            this.calculateTimeWindow();
            calculatedRate = this.cubicSuccess(this.getCurrentTimeInSeconds());
        }
        const newRate = Math.min(calculatedRate, 2 * this.measuredTxRate);
        this.updateTokenBucketRate(newRate);
    }
    calculateTimeWindow() {
        this.timeWindow = this.getPrecise(Math.pow((this.lastMaxRate * (1 - this.beta)) / this.scaleConstant, 1 / 3));
    }
    cubicThrottle(rateToUse) {
        return this.getPrecise(rateToUse * this.beta);
    }
    cubicSuccess(timestamp) {
        return this.getPrecise(this.scaleConstant * Math.pow(timestamp - this.lastThrottleTime - this.timeWindow, 3) + this.lastMaxRate);
    }
    enableTokenBucket() {
        this.enabled = true;
    }
    updateTokenBucketRate(newRate) {
        this.refillTokenBucket();
        this.fillRate = Math.max(newRate, this.minFillRate);
        this.maxCapacity = Math.max(newRate, this.minCapacity);
        this.currentCapacity = Math.min(this.currentCapacity, this.maxCapacity);
    }
    updateMeasuredRate() {
        const t = this.getCurrentTimeInSeconds();
        const timeBucket = Math.floor(t * 2) / 2;
        this.requestCount++;
        if (timeBucket > this.lastTxRateBucket) {
            const currentRate = this.requestCount / (timeBucket - this.lastTxRateBucket);
            this.measuredTxRate = this.getPrecise(currentRate * this.smooth + this.measuredTxRate * (1 - this.smooth));
            this.requestCount = 0;
            this.lastTxRateBucket = timeBucket;
        }
    }
    getPrecise(num) {
        return parseFloat(num.toFixed(8));
    }
}
exports.DefaultRateLimiter = DefaultRateLimiter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVmYXVsdFJhdGVMaW1pdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0RlZmF1bHRSYXRlTGltaXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx3RkFBMEU7QUFZMUUsTUFBYSxrQkFBa0I7SUF1QjdCLFlBQVksT0FBbUM7O1FBZHZDLG9CQUFlLEdBQUcsQ0FBQyxDQUFDO1FBQ3BCLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFDaEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFDaEIsbUJBQWMsR0FBRyxDQUFDLENBQUM7UUFDbkIsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFLakIsa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFHbEIsZUFBVSxHQUFHLENBQUMsQ0FBQztRQUdyQixJQUFJLENBQUMsSUFBSSxHQUFHLE1BQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLElBQUksbUNBQUksR0FBRyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsV0FBVyxtQ0FBSSxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFBLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxXQUFXLG1DQUFJLEdBQUcsQ0FBQztRQUMvQyxJQUFJLENBQUMsYUFBYSxHQUFHLE1BQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLGFBQWEsbUNBQUksR0FBRyxDQUFDO1FBQ25ELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsTUFBTSxtQ0FBSSxHQUFHLENBQUM7UUFFckMsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUM1RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsb0JBQW9CLENBQUM7UUFDN0MsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElB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QzFFLENBQUM7SUFFTyxrQkFBa0I7UUFDeEIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFDekMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUVwQixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDdEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUM3RSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMzRyxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztZQUN0QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsVUFBVSxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQztJQUVPLFVBQVUsQ0FBQyxHQUFXO1FBQzVCLE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQyxDQUFDO0NBQ0Y7QUF6SUQsZ0RBeUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNUaHJvdHRsaW5nRXJyb3IgfSBmcm9tIFwiQGF3cy1zZGsvc2VydmljZS1lcnJvci1jbGFzc2lmaWNhdGlvblwiO1xuXG5pbXBvcnQgeyBSYXRlTGltaXRlciB9IGZyb20gXCIuL3R5cGVzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVmYXVsdFJhdGVMaW1pdGVyT3B0aW9ucyB7XG4gIGJldGE/OiBudW1iZXI7XG4gIG1pbkNhcGFjaXR5PzogbnVtYmVyO1xuICBtaW5GaWxsUmF0ZT86IG51bWJlcjtcbiAgc2NhbGVDb25zdGFudD86IG51bWJlcjtcbiAgc21vb3RoPzogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgRGVmYXVsdFJhdGVMaW1pdGVyIGltcGxlbWVudHMgUmF0ZUxpbWl0ZXIge1xuICAvLyBVc2VyIGNvbmZpZ3VyYWJsZSBjb25zdGFudHNcbiAgcHJpdmF0ZSBiZXRhOiBudW1iZXI7XG4gIHByaXZhdGUgbWluQ2FwYWNpdHk6IG51bWJlcjtcbiAgcHJpdmF0ZSBtaW5GaWxsUmF0ZTogbnVtYmVyO1xuICBwcml2YXRlIHNjYWxlQ29uc3RhbnQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBzbW9vdGg6IG51bWJlcjtcblxuICAvLyBQcmUtc2V0IHN0YXRlIHZhcmlhYmxlc1xuICBwcml2YXRlIGN1cnJlbnRDYXBhY2l0eSA9IDA7XG4gIHByaXZhdGUgZW5hYmxlZCA9IGZhbHNlO1xuICBwcml2YXRlIGxhc3RNYXhSYXRlID0gMDtcbiAgcHJpdmF0ZSBtZWFzdXJlZFR4UmF0ZSA9IDA7XG4gIHByaXZhdGUgcmVxdWVzdENvdW50ID0gMDtcblxuICAvLyBPdGhlciBzdGF0ZSB2YXJpYWJsZXNcbiAgcHJpdmF0ZSBmaWxsUmF0ZTogbnVtYmVyO1xuICBwcml2YXRlIGxhc3RUaHJvdHRsZVRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSBsYXN0VGltZXN0YW1wID0gMDtcbiAgcHJpdmF0ZSBsYXN0VHhSYXRlQnVja2V0OiBudW1iZXI7XG4gIHByaXZhdGUgbWF4Q2FwYWNpdHk6IG51bWJlcjtcbiAgcHJpdmF0ZSB0aW1lV2luZG93ID0gMDtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zPzogRGVmYXVsdFJhdGVMaW1pdGVyT3B0aW9ucykge1xuICAgIHRoaXMuYmV0YSA9IG9wdGlvbnM/LmJldGEgPz8gMC43O1xuICAgIHRoaXMubWluQ2FwYWNpdHkgPSBvcHRpb25zPy5taW5DYXBhY2l0eSA/PyAxO1xuICAgIHRoaXMubWluRmlsbFJhdGUgPSBvcHRpb25zPy5taW5GaWxsUmF0ZSA/PyAwLjU7XG4gICAgdGhpcy5zY2FsZUNvbnN0YW50ID0gb3B0aW9ucz8uc2NhbGVDb25zdGFudCA/PyAwLjQ7XG4gICAgdGhpcy5zbW9vdGggPSBvcHRpb25zPy5zbW9vdGggPz8gMC44O1xuXG4gICAgY29uc3QgY3VycmVudFRpbWVJblNlY29uZHMgPSB0aGlzLmdldEN1cnJlbnRUaW1lSW5TZWNvbmRzKCk7XG4gICAgdGhpcy5sYXN0VGhyb3R0bGVUaW1lID0gY3VycmVudFRpbWVJblNlY29uZHM7XG4gICAgdGhpcy5sYXN0VHhSYXRlQnVja2V0ID0gTWF0aC5mbG9vcih0aGlzLmdldEN1cnJlbnRUaW1lSW5TZWNvbmRzKCkpO1xuXG4gICAgdGhpcy5maWxsUmF0ZSA9IHRoaXMubWluRmlsbFJhdGU7XG4gICAgdGhpcy5tYXhDYXBhY2l0eSA9IHRoaXMubWluQ2FwYWNpdHk7XG4gIH1cblxuICBwcml2YXRlIGdldEN1cnJlbnRUaW1lSW5TZWNvbmRzKCkge1xuICAgIHJldHVybiBEYXRlLm5vdygpIC8gMTAwMDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRTZW5kVG9rZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMuYWNxdWlyZVRva2VuQnVja2V0KDEpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBhY3F1aXJlVG9rZW5CdWNrZXQoYW1vdW50OiBudW1iZXIpIHtcbiAgICAvLyBDbGllbnQgc2lkZSB0aHJvdHRsaW5nIGlzIG5vdCBlbmFibGVkIHVudGlsIHdlIHNlZSBhIHRocm90dGxpbmcgZXJyb3IuXG4gICAgaWYgKCF0aGlzLmVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnJlZmlsbFRva2VuQnVja2V0KCk7XG4gICAgaWYgKGFtb3VudCA+IHRoaXMuY3VycmVudENhcGFjaXR5KSB7XG4gICAgICBjb25zdCBkZWxheSA9ICgoYW1vdW50IC0gdGhpcy5jdXJyZW50Q2FwYWNpdHkpIC8gdGhpcy5maWxsUmF0ZSkgKiAxMDAwO1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXkpKTtcbiAgICB9XG4gICAgdGhpcy5jdXJyZW50Q2FwYWNpdHkgPSB0aGlzLmN1cnJlbnRDYXBhY2l0eSAtIGFtb3VudDtcbiAgfVxuXG4gIHByaXZhdGUgcmVmaWxsVG9rZW5CdWNrZXQoKSB7XG4gICAgY29uc3QgdGltZXN0YW1wID0gdGhpcy5nZXRDdXJyZW50VGltZUluU2Vjb25kcygpO1xuICAgIGlmICghdGhpcy5sYXN0VGltZXN0YW1wKSB7XG4gICAgICB0aGlzLmxhc3RUaW1lc3RhbXAgPSB0aW1lc3RhbXA7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZmlsbEFtb3VudCA9ICh0aW1lc3RhbXAgLSB0aGlzLmxhc3RUaW1lc3RhbXApICogdGhpcy5maWxsUmF0ZTtcbiAgICB0aGlzLmN1cnJlbnRDYXBhY2l0eSA9IE1hdGgubWluKHRoaXMubWF4Q2FwYWNpdHksIHRoaXMuY3VycmVudENhcGFjaXR5ICsgZmlsbEFtb3VudCk7XG4gICAgdGhpcy5sYXN0VGltZXN0YW1wID0gdGltZXN0YW1wO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZUNsaWVudFNlbmRpbmdSYXRlKHJlc3BvbnNlOiBhbnkpIHtcbiAgICBsZXQgY2FsY3VsYXRlZFJhdGU6IG51bWJlcjtcbiAgICB0aGlzLnVwZGF0ZU1lYXN1cmVkUmF0ZSgpO1xuXG4gICAgaWYgKGlzVGhyb3R0bGluZ0Vycm9yKHJlc3BvbnNlKSkge1xuICAgICAgY29uc3QgcmF0ZVRvVXNlID0gIXRoaXMuZW5hYmxlZCA/IHRoaXMubWVhc3VyZWRUeFJhdGUgOiBNYXRoLm1pbih0aGlzLm1lYXN1cmVkVHhSYXRlLCB0aGlzLmZpbGxSYXRlKTtcbiAgICAgIHRoaXMubGFzdE1heFJhdGUgPSByYXRlVG9Vc2U7XG4gICAgICB0aGlzLmNhbGN1bGF0ZVRpbWVXaW5kb3coKTtcbiAgICAgIHRoaXMubGFzdFRocm90dGxlVGltZSA9IHRoaXMuZ2V0Q3VycmVudFRpbWVJblNlY29uZHMoKTtcbiAgICAgIGNhbGN1bGF0ZWRSYXRlID0gdGhpcy5jdWJpY1Rocm90dGxlKHJhdGVUb1VzZSk7XG4gICAgICB0aGlzLmVuYWJsZVRva2VuQnVja2V0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2FsY3VsYXRlVGltZVdpbmRvdygpO1xuICAgICAgY2FsY3VsYXRlZFJhdGUgPSB0aGlzLmN1YmljU3VjY2Vzcyh0aGlzLmdldEN1cnJlbnRUaW1lSW5TZWNvbmRzKCkpO1xuICAgIH1cblxuICAgIGNvbnN0IG5ld1JhdGUgPSBNYXRoLm1pbihjYWxjdWxhdGVkUmF0ZSwgMiAqIHRoaXMubWVhc3VyZWRUeFJhdGUpO1xuICAgIHRoaXMudXBkYXRlVG9rZW5CdWNrZXRSYXRlKG5ld1JhdGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVUaW1lV2luZG93KCkge1xuICAgIHRoaXMudGltZVdpbmRvdyA9IHRoaXMuZ2V0UHJlY2lzZShNYXRoLnBvdygodGhpcy5sYXN0TWF4UmF0ZSAqICgxIC0gdGhpcy5iZXRhKSkgLyB0aGlzLnNjYWxlQ29uc3RhbnQsIDEgLyAzKSk7XG4gIH1cblxuICBwcml2YXRlIGN1YmljVGhyb3R0bGUocmF0ZVRvVXNlOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRQcmVjaXNlKHJhdGVUb1VzZSAqIHRoaXMuYmV0YSk7XG4gIH1cblxuICBwcml2YXRlIGN1YmljU3VjY2Vzcyh0aW1lc3RhbXA6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmdldFByZWNpc2UoXG4gICAgICB0aGlzLnNjYWxlQ29uc3RhbnQgKiBNYXRoLnBvdyh0aW1lc3RhbXAgLSB0aGlzLmxhc3RUaHJvdHRsZVRpbWUgLSB0aGlzLnRpbWVXaW5kb3csIDMpICsgdGhpcy5sYXN0TWF4UmF0ZVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGVuYWJsZVRva2VuQnVja2V0KCkge1xuICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVRva2VuQnVja2V0UmF0ZShuZXdSYXRlOiBudW1iZXIpIHtcbiAgICAvLyBSZWZpbGwgYmFzZWQgb24gb3VyIGN1cnJlbnQgcmF0ZSBiZWZvcmUgd2UgdXBkYXRlIHRvIHRoZSBuZXcgZmlsbCByYXRlLlxuICAgIHRoaXMucmVmaWxsVG9rZW5CdWNrZXQoKTtcblxuICAgIHRoaXMuZmlsbFJhdGUgPSBNYXRoLm1heChuZXdSYXRlLCB0aGlzLm1pbkZpbGxSYXRlKTtcbiAgICB0aGlzLm1heENhcGFjaXR5ID0gTWF0aC5tYXgobmV3UmF0ZSwgdGhpcy5taW5DYXBhY2l0eSk7XG5cbiAgICAvLyBXaGVuIHdlIHNjYWxlIGRvd24gd2UgY2FuJ3QgaGF2ZSBhIGN1cnJlbnQgY2FwYWNpdHkgdGhhdCBleGNlZWRzIG91ciBtYXhDYXBhY2l0eS5cbiAgICB0aGlzLmN1cnJlbnRDYXBhY2l0eSA9IE1hdGgubWluKHRoaXMuY3VycmVudENhcGFjaXR5LCB0aGlzLm1heENhcGFjaXR5KTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlTWVhc3VyZWRSYXRlKCkge1xuICAgIGNvbnN0IHQgPSB0aGlzLmdldEN1cnJlbnRUaW1lSW5TZWNvbmRzKCk7XG4gICAgY29uc3QgdGltZUJ1Y2tldCA9IE1hdGguZmxvb3IodCAqIDIpIC8gMjtcbiAgICB0aGlzLnJlcXVlc3RDb3VudCsrO1xuXG4gICAgaWYgKHRpbWVCdWNrZXQgPiB0aGlzLmxhc3RUeFJhdGVCdWNrZXQpIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRSYXRlID0gdGhpcy5yZXF1ZXN0Q291bnQgLyAodGltZUJ1Y2tldCAtIHRoaXMubGFzdFR4UmF0ZUJ1Y2tldCk7XG4gICAgICB0aGlzLm1lYXN1cmVkVHhSYXRlID0gdGhpcy5nZXRQcmVjaXNlKGN1cnJlbnRSYXRlICogdGhpcy5zbW9vdGggKyB0aGlzLm1lYXN1cmVkVHhSYXRlICogKDEgLSB0aGlzLnNtb290aCkpO1xuICAgICAgdGhpcy5yZXF1ZXN0Q291bnQgPSAwO1xuICAgICAgdGhpcy5sYXN0VHhSYXRlQnVja2V0ID0gdGltZUJ1Y2tldDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFByZWNpc2UobnVtOiBudW1iZXIpIHtcbiAgICByZXR1cm4gcGFyc2VGbG9hdChudW0udG9GaXhlZCg4KSk7XG4gIH1cbn1cbiJdfQ==