"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getHomeDir = exports.loadSharedConfigFiles = exports.ENV_CONFIG_PATH = exports.ENV_CREDENTIALS_PATH = void 0;
const fs_1 = require("fs");
const os_1 = require("os");
const path_1 = require("path");
exports.ENV_CREDENTIALS_PATH = "AWS_SHARED_CREDENTIALS_FILE";
exports.ENV_CONFIG_PATH = "AWS_CONFIG_FILE";
const swallowError = () => ({});
const loadSharedConfigFiles = (init = {}) => {
    const { filepath = process.env[exports.ENV_CREDENTIALS_PATH] || path_1.join(exports.getHomeDir(), ".aws", "credentials"), configFilepath = process.env[exports.ENV_CONFIG_PATH] || path_1.join(exports.getHomeDir(), ".aws", "config"), } = init;
    return Promise.all([
        slurpFile(configFilepath).then(parseIni).then(normalizeConfigFile).catch(swallowError),
        slurpFile(filepath).then(parseIni).catch(swallowError),
    ]).then((parsedFiles) => {
        const [configFile, credentialsFile] = parsedFiles;
        return {
            configFile,
            credentialsFile,
        };
    });
};
exports.loadSharedConfigFiles = loadSharedConfigFiles;
const profileKeyRegex = /^profile\s(["'])?([^\1]+)\1$/;
const normalizeConfigFile = (data) => {
    const map = {};
    for (const key of Object.keys(data)) {
        let matches;
        if (key === "default") {
            map.default = data.default;
        }
        else if ((matches = profileKeyRegex.exec(key))) {
            const [_1, _2, normalizedKey] = matches;
            if (normalizedKey) {
                map[normalizedKey] = data[key];
            }
        }
    }
    return map;
};
const profileNameBlockList = ["__proto__", "profile __proto__"];
const parseIni = (iniData) => {
    const map = {};
    let currentSection;
    for (let line of iniData.split(/\r?\n/)) {
        line = line.split(/(^|\s)[;#]/)[0];
        const section = line.match(/^\s*\[([^\[\]]+)]\s*$/);
        if (section) {
            currentSection = section[1];
            if (profileNameBlockList.includes(currentSection)) {
                throw new Error(`Found invalid profile name "${currentSection}"`);
            }
        }
        else if (currentSection) {
            const item = line.match(/^\s*(.+?)\s*=\s*(.+?)\s*$/);
            if (item) {
                map[currentSection] = map[currentSection] || {};
                map[currentSection][item[1]] = item[2];
            }
        }
    }
    return map;
};
const slurpFile = (path) => new Promise((resolve, reject) => {
    fs_1.readFile(path, "utf8", (err, data) => {
        if (err) {
            reject(err);
        }
        else {
            resolve(data);
        }
    });
});
const getHomeDir = () => {
    const { HOME, USERPROFILE, HOMEPATH, HOMEDRIVE = `C:${path_1.sep}` } = process.env;
    if (HOME)
        return HOME;
    if (USERPROFILE)
        return USERPROFILE;
    if (HOMEPATH)
        return `${HOMEDRIVE}${HOMEPATH}`;
    return os_1.homedir();
};
exports.getHomeDir = getHomeDir;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkJBQThCO0FBQzlCLDJCQUE2QjtBQUM3QiwrQkFBaUM7QUFFcEIsUUFBQSxvQkFBb0IsR0FBRyw2QkFBNkIsQ0FBQztBQUNyRCxRQUFBLGVBQWUsR0FBRyxpQkFBaUIsQ0FBQztBQStCakQsTUFBTSxZQUFZLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUV6QixNQUFNLHFCQUFxQixHQUFHLENBQUMsT0FBeUIsRUFBRSxFQUE4QixFQUFFO0lBQy9GLE1BQU0sRUFDSixRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyw0QkFBb0IsQ0FBQyxJQUFJLFdBQUksQ0FBQyxrQkFBVSxFQUFFLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxFQUN6RixjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBZSxDQUFDLElBQUksV0FBSSxDQUFDLGtCQUFVLEVBQUUsRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDLEdBQ3RGLEdBQUcsSUFBSSxDQUFDO0lBRVQsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDO1FBQ2pCLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztRQUN0RixTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7S0FDdkQsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFdBQWlDLEVBQUUsRUFBRTtRQUM1QyxNQUFNLENBQUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxHQUFHLFdBQVcsQ0FBQztRQUNsRCxPQUFPO1lBQ0wsVUFBVTtZQUNWLGVBQWU7U0FDaEIsQ0FBQztJQUNKLENB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LE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFFNUUsSUFBSSxJQUFJO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDdEIsSUFBSSxXQUFXO1FBQUUsT0FBTyxXQUFXLENBQUM7SUFDcEMsSUFBSSxRQUFRO1FBQUUsT0FBTyxHQUFHLFNBQVMsR0FBRyxRQUFRLEVBQUUsQ0FBQztJQUUvQyxPQUFPLFlBQU8sRUFBRSxDQUFDO0FBQ25CLENBQUMsQ0FBQztBQVJXLFFBQUEsVUFBVSxjQVFyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlYWRGaWxlIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBob21lZGlyIH0gZnJvbSBcIm9zXCI7XG5pbXBvcnQgeyBqb2luLCBzZXAgfSBmcm9tIFwicGF0aFwiO1xuXG5leHBvcnQgY29uc3QgRU5WX0NSRURFTlRJQUxTX1BBVEggPSBcIkFXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRVwiO1xuZXhwb3J0IGNvbnN0IEVOVl9DT05GSUdfUEFUSCA9IFwiQVdTX0NPTkZJR19GSUxFXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2hhcmVkQ29uZmlnSW5pdCB7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCBhdCB3aGljaCB0byBsb2NhdGUgdGhlIGluaSBjcmVkZW50aWFscyBmaWxlLiBEZWZhdWx0cyB0byB0aGVcbiAgICogdmFsdWUgb2YgdGhlIGBBV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEVgIGVudmlyb25tZW50IHZhcmlhYmxlIChpZlxuICAgKiBkZWZpbmVkKSBvciBgfi8uYXdzL2NyZWRlbnRpYWxzYCBvdGhlcndpc2UuXG4gICAqL1xuICBmaWxlcGF0aD86IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHBhdGggYXQgd2hpY2ggdG8gbG9jYXRlIHRoZSBpbmkgY29uZmlnIGZpbGUuIERlZmF1bHRzIHRvIHRoZSB2YWx1ZSBvZlxuICAgKiB0aGUgYEFXU19DT05GSUdfRklMRWAgZW52aXJvbm1lbnQgdmFyaWFibGUgKGlmIGRlZmluZWQpIG9yXG4gICAqIGB+Ly5hd3MvY29uZmlnYCBvdGhlcndpc2UuXG4gICAqL1xuICBjb25maWdGaWxlcGF0aD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcm9maWxlIHtcbiAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhcnNlZEluaURhdGEge1xuICBba2V5OiBzdHJpbmddOiBQcm9maWxlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNoYXJlZENvbmZpZ0ZpbGVzIHtcbiAgY3JlZGVudGlhbHNGaWxlOiBQYXJzZWRJbmlEYXRhO1xuICBjb25maWdGaWxlOiBQYXJzZWRJbmlEYXRhO1xufVxuXG5jb25zdCBzd2FsbG93RXJyb3IgPSAoKSA9PiAoe30pO1xuXG5leHBvcnQgY29uc3QgbG9hZFNoYXJlZENvbmZpZ0ZpbGVzID0gKGluaXQ6IFNoYXJlZENvbmZpZ0luaXQgPSB7fSk6IFByb21pc2U8U2hhcmVkQ29uZmlnRmlsZXM+ID0+IHtcbiAgY29uc3Qge1xuICAgIGZpbGVwYXRoID0gcHJvY2Vzcy5lbnZbRU5WX0NSRURFTlRJQUxTX1BBVEhdIHx8IGpvaW4oZ2V0SG9tZURpcigpLCBcIi5hd3NcIiwgXCJjcmVkZW50aWFsc1wiKSxcbiAgICBjb25maWdGaWxlcGF0aCA9IHByb2Nlc3MuZW52W0VOVl9DT05GSUdfUEFUSF0gfHwgam9pbihnZXRIb21lRGlyKCksIFwiLmF3c1wiLCBcImNvbmZpZ1wiKSxcbiAgfSA9IGluaXQ7XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICBzbHVycEZpbGUoY29uZmlnRmlsZXBhdGgpLnRoZW4ocGFyc2VJbmkpLnRoZW4obm9ybWFsaXplQ29uZmlnRmlsZSkuY2F0Y2goc3dhbGxvd0Vycm9yKSxcbiAgICBzbHVycEZpbGUoZmlsZXBhdGgpLnRoZW4ocGFyc2VJbmkpLmNhdGNoKHN3YWxsb3dFcnJvciksXG4gIF0pLnRoZW4oKHBhcnNlZEZpbGVzOiBBcnJheTxQYXJzZWRJbmlEYXRhPikgPT4ge1xuICAgIGNvbnN0IFtjb25maWdGaWxlLCBjcmVkZW50aWFsc0ZpbGVdID0gcGFyc2VkRmlsZXM7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbmZpZ0ZpbGUsXG4gICAgICBjcmVkZW50aWFsc0ZpbGUsXG4gICAgfTtcbiAgfSk7XG59O1xuXG5jb25zdCBwcm9maWxlS2V5UmVnZXggPSAvXnByb2ZpbGVcXHMoW1wiJ10pPyhbXlxcMV0rKVxcMSQvO1xuY29uc3Qgbm9ybWFsaXplQ29uZmlnRmlsZSA9IChkYXRhOiBQYXJzZWRJbmlEYXRhKTogUGFyc2VkSW5pRGF0YSA9PiB7XG4gIGNvbnN0IG1hcDogUGFyc2VkSW5pRGF0YSA9IHt9O1xuICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhkYXRhKSkge1xuICAgIGxldCBtYXRjaGVzOiBBcnJheTxzdHJpbmc+IHwgbnVsbDtcbiAgICBpZiAoa2V5ID09PSBcImRlZmF1bHRcIikge1xuICAgICAgbWFwLmRlZmF1bHQgPSBkYXRhLmRlZmF1bHQ7XG4gICAgfSBlbHNlIGlmICgobWF0Y2hlcyA9IHByb2ZpbGVLZXlSZWdleC5leGVjKGtleSkpKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzXG4gICAgICBjb25zdCBbXzEsIF8yLCBub3JtYWxpemVkS2V5XSA9IG1hdGNoZXM7XG4gICAgICBpZiAobm9ybWFsaXplZEtleSkge1xuICAgICAgICBtYXBbbm9ybWFsaXplZEtleV0gPSBkYXRhW2tleV07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1hcDtcbn07XG5cbmNvbnN0IHByb2ZpbGVOYW1lQmxvY2tMaXN0ID0gW1wiX19wcm90b19fXCIsIFwicHJvZmlsZSBfX3Byb3RvX19cIl07XG5jb25zdCBwYXJzZUluaSA9IChpbmlEYXRhOiBzdHJpbmcpOiBQYXJzZWRJbmlEYXRhID0+IHtcbiAgY29uc3QgbWFwOiBQYXJzZWRJbmlEYXRhID0ge307XG4gIGxldCBjdXJyZW50U2VjdGlvbjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBmb3IgKGxldCBsaW5lIG9mIGluaURhdGEuc3BsaXQoL1xccj9cXG4vKSkge1xuICAgIGxpbmUgPSBsaW5lLnNwbGl0KC8oXnxcXHMpWzsjXS8pWzBdOyAvLyByZW1vdmUgY29tbWVudHNcbiAgICBjb25zdCBzZWN0aW9uID0gbGluZS5tYXRjaCgvXlxccypcXFsoW15cXFtcXF1dKyldXFxzKiQvKTtcbiAgICBpZiAoc2VjdGlvbikge1xuICAgICAgY3VycmVudFNlY3Rpb24gPSBzZWN0aW9uWzFdO1xuICAgICAgaWYgKHByb2ZpbGVOYW1lQmxvY2tMaXN0LmluY2x1ZGVzKGN1cnJlbnRTZWN0aW9uKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZvdW5kIGludmFsaWQgcHJvZmlsZSBuYW1lIFwiJHtjdXJyZW50U2VjdGlvbn1cImApO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoY3VycmVudFNlY3Rpb24pIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSBsaW5lLm1hdGNoKC9eXFxzKiguKz8pXFxzKj1cXHMqKC4rPylcXHMqJC8pO1xuICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXSA9IG1hcFtjdXJyZW50U2VjdGlvbl0gfHwge307XG4gICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl1baXRlbVsxXV0gPSBpdGVtWzJdO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYXA7XG59O1xuXG5jb25zdCBzbHVycEZpbGUgPSAocGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+ID0+XG4gIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICByZWFkRmlsZShwYXRoLCBcInV0ZjhcIiwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUoZGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4vKipcbiAqIEdldCB0aGUgSE9NRSBkaXJlY3RvcnkgZm9yIHRoZSBjdXJyZW50IHJ1bnRpbWUuXG4gKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRIb21lRGlyID0gKCk6IHN0cmluZyA9PiB7XG4gIGNvbnN0IHsgSE9NRSwgVVNFUlBST0ZJTEUsIEhPTUVQQVRILCBIT01FRFJJVkUgPSBgQzoke3NlcH1gIH0gPSBwcm9jZXNzLmVudjtcblxuICBpZiAoSE9NRSkgcmV0dXJuIEhPTUU7XG4gIGlmIChVU0VSUFJPRklMRSkgcmV0dXJuIFVTRVJQUk9GSUxFO1xuICBpZiAoSE9NRVBBVEgpIHJldHVybiBgJHtIT01FRFJJVkV9JHtIT01FUEFUSH1gO1xuXG4gIHJldHVybiBob21lZGlyKCk7XG59O1xuIl19