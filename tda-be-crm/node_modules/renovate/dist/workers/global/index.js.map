{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/workers/global/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { ERROR } from 'bunyan';\nimport fs from 'fs-extra';\nimport { satisfies } from 'semver';\nimport upath from 'upath';\nimport * as pkg from '../../../package.json';\nimport * as configParser from '../../config';\nimport { resolveConfigPresets } from '../../config/presets';\nimport { validateConfigSecrets } from '../../config/secrets';\nimport type {\n  AllConfig,\n  RenovateConfig,\n  RenovateRepository,\n} from '../../config/types';\nimport { CONFIG_PRESETS_INVALID } from '../../constants/error-messages';\nimport { getProblems, logger, setMeta } from '../../logger';\nimport { writeFile } from '../../util/fs';\nimport * as hostRules from '../../util/host-rules';\nimport * as repositoryWorker from '../repository';\nimport { autodiscoverRepositories } from './autodiscover';\nimport { parseConfigs } from './config/parse';\nimport { globalFinalize, globalInitialize } from './initialize';\nimport { Limit, isLimitReached } from './limits';\n\nexport async function getRepositoryConfig(\n  globalConfig: RenovateConfig,\n  repository: RenovateRepository\n): Promise<RenovateConfig> {\n  const repoConfig = configParser.mergeChildConfig(\n    globalConfig,\n    is.string(repository) ? { repository } : repository\n  );\n  repoConfig.localDir = upath.join(\n    repoConfig.baseDir,\n    `./repos/${repoConfig.platform}/${repoConfig.repository}`\n  );\n  await fs.ensureDir(repoConfig.localDir);\n  delete repoConfig.baseDir;\n  return configParser.filterConfig(repoConfig, 'repository');\n}\n\nfunction getGlobalConfig(): Promise<RenovateConfig> {\n  return parseConfigs(process.env, process.argv);\n}\n\nfunction haveReachedLimits(): boolean {\n  if (isLimitReached(Limit.Commits)) {\n    logger.info('Max commits created for this run.');\n    return true;\n  }\n  return false;\n}\n\n/* istanbul ignore next */\nfunction checkEnv(): void {\n  const range = pkg.engines.node;\n  const rangeNext = pkg['engines-next']?.node;\n  if (process.release?.name !== 'node' || !process.versions?.node) {\n    logger.warn(\n      { release: process.release, versions: process.versions },\n      'Unknown node environment detected.'\n    );\n  } else if (!satisfies(process.versions?.node, range)) {\n    logger.error(\n      { versions: process.versions, range },\n      'Unsupported node environment detected. Please update your node version.'\n    );\n  } else if (rangeNext && !satisfies(process.versions?.node, rangeNext)) {\n    logger.warn(\n      { versions: process.versions },\n      `Please upgrade the version of Node.js used to run Renovate to satisfy \"${rangeNext}\". Support for your current version will be removed in Renovate's next major release.`\n    );\n  }\n}\n\nexport async function validatePresets(config: AllConfig): Promise<void> {\n  try {\n    await resolveConfigPresets(config);\n  } catch (err) /* istanbul ignore next */ {\n    throw new Error(CONFIG_PRESETS_INVALID);\n  }\n}\n\nexport async function start(): Promise<number> {\n  let config: AllConfig;\n  try {\n    // read global config from file, env and cli args\n    config = await getGlobalConfig();\n    // initialize all submodules\n    config = await globalInitialize(config);\n\n    await validatePresets(config);\n\n    checkEnv();\n\n    // validate secrets. Will throw and abort if invalid\n    validateConfigSecrets(config);\n\n    // autodiscover repositories (needs to come after platform initialization)\n    config = await autodiscoverRepositories(config);\n\n    if (is.nonEmptyString(config.writeDiscoveredRepos)) {\n      const content = JSON.stringify(config.repositories);\n      await writeFile(config.writeDiscoveredRepos, content);\n      logger.info(\n        `Written discovered repositories to ${config.writeDiscoveredRepos}`\n      );\n      return 0;\n    }\n\n    // Iterate through repositories sequentially\n    for (const repository of config.repositories) {\n      if (haveReachedLimits()) {\n        break;\n      }\n      const repoConfig = await getRepositoryConfig(config, repository);\n      if (repoConfig.hostRules) {\n        hostRules.clear();\n        repoConfig.hostRules.forEach((rule) => hostRules.add(rule));\n        repoConfig.hostRules = [];\n      }\n      await repositoryWorker.renovateRepository(repoConfig);\n      setMeta({});\n    }\n  } catch (err) /* istanbul ignore next */ {\n    if (err.message.startsWith('Init: ')) {\n      logger.fatal(err.message.substring(6));\n    } else {\n      logger.fatal({ err }, `Fatal error: ${String(err.message)}`);\n    }\n    if (!config) {\n      // return early if we can't parse config options\n      logger.debug(`Missing config`);\n      return 2;\n    }\n  } finally {\n    globalFinalize(config);\n    logger.debug(`Renovate exiting`);\n  }\n  const loggerErrors = getProblems().filter((p) => p.level >= ERROR);\n  if (loggerErrors.length) {\n    logger.info(\n      { loggerErrors },\n      'Renovate is exiting with a non-zero code due to the following logged errors'\n    );\n    return 1;\n  }\n  return 0;\n}\n"]}