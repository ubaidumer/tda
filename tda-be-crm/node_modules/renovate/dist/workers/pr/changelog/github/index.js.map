{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../lib/workers/pr/changelog/github/index.ts"],"names":[],"mappings":"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","sourcesContent":["import changelogFilenameRegex from 'changelog-filename-regex';\nimport type { GithubRelease } from '../../../../datasource/github-releases/types';\nimport type { GitHubTag } from '../../../../datasource/github-tags/types';\nimport { logger } from '../../../../logger';\nimport type {\n  GithubGitBlob,\n  GithubGitTree,\n  GithubGitTreeNode,\n} from '../../../../types/platform/github';\nimport { GithubHttp } from '../../../../util/http/github';\nimport { ensureTrailingSlash } from '../../../../util/url';\nimport type { ChangeLogFile, ChangeLogNotes } from '../types';\n\nconst http = new GithubHttp();\n\nexport async function getTags(\n  endpoint: string,\n  repository: string\n): Promise<string[]> {\n  logger.trace('github.getTags()');\n  const url = `${endpoint}repos/${repository}/tags?per_page=100`;\n  try {\n    const res = await http.getJson<GitHubTag[]>(url, {\n      paginate: true,\n    });\n\n    const tags = res.body;\n\n    if (!tags.length) {\n      logger.debug({ repository }, 'repository has no Github tags');\n    }\n\n    return tags.map((tag) => tag.name).filter(Boolean);\n  } catch (err) {\n    logger.debug(\n      { sourceRepo: repository, err },\n      'Failed to fetch Github tags'\n    );\n    // istanbul ignore if\n    if (err.message?.includes('Bad credentials')) {\n      logger.warn('Bad credentials triggering tag fail lookup in changelog');\n      throw err;\n    }\n    return [];\n  }\n}\n\nexport async function getReleaseNotesMd(\n  repository: string,\n  apiBaseUrl: string,\n  sourceDirectory: string\n): Promise<ChangeLogFile> | null {\n  logger.trace('github.getReleaseNotesMd()');\n  const apiPrefix = `${ensureTrailingSlash(apiBaseUrl)}repos/${repository}`;\n  const { default_branch: defaultBranch = 'master' } = (\n    await http.getJson<{ default_branch: string }>(apiPrefix)\n  ).body;\n\n  // https://docs.github.com/en/rest/reference/git#get-a-tree\n  const res = await http.getJson<GithubGitTree>(\n    `${apiPrefix}/git/trees/${defaultBranch}${\n      sourceDirectory ? '?recursive=1' : ''\n    }`\n  );\n\n  // istanbul ignore if\n  if (res.body.truncated) {\n    logger.debug({ repository }, 'Git tree truncated');\n  }\n\n  const allFiles = res.body.tree.filter((f) => f.type === 'blob');\n  let files: GithubGitTreeNode[] = [];\n  if (sourceDirectory?.length) {\n    files = allFiles\n      .filter((f) => f.path.startsWith(sourceDirectory))\n      .filter((f) =>\n        changelogFilenameRegex.test(\n          f.path.replace(ensureTrailingSlash(sourceDirectory), '')\n        )\n      );\n  }\n  if (!files.length) {\n    files = allFiles.filter((f) => changelogFilenameRegex.test(f.path));\n  }\n  if (!files.length) {\n    logger.trace('no changelog file found');\n    return null;\n  }\n  const { path: changelogFile, sha } = files.shift();\n  /* istanbul ignore if */\n  if (files.length !== 0) {\n    logger.debug(\n      `Multiple candidates for changelog file, using ${changelogFile}`\n    );\n  }\n\n  // https://docs.github.com/en/rest/reference/git#get-a-blob\n  const fileRes = await http.getJson<GithubGitBlob>(\n    `${apiPrefix}/git/blobs/${sha}`\n  );\n\n  const changelogMd =\n    Buffer.from(fileRes.body.content, 'base64').toString() + '\\n#\\n##';\n  return { changelogFile, changelogMd };\n}\n\nexport async function getReleaseList(\n  apiBaseUrl: string,\n  repository: string\n): Promise<ChangeLogNotes[]> {\n  logger.trace('github.getReleaseList()');\n  const url = `${ensureTrailingSlash(apiBaseUrl)}repos/${repository}/releases`;\n  const res = await http.getJson<GithubRelease[]>(`${url}?per_page=100`, {\n    paginate: true,\n  });\n  return res.body.map((release) => ({\n    url: release.html_url,\n    notesSourceUrl: url,\n    id: release.id,\n    tag: release.tag_name,\n    name: release.name,\n    body: release.body,\n  }));\n}\n"]}