{"version":3,"file":"execute-post-upgrade-commands.js","sourceRoot":"","sources":["../../../lib/workers/branch/execute-post-upgrade-commands.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport minimatch from 'minimatch';\nimport { GlobalConfig } from '../../config/global';\nimport { addMeta, logger } from '../../logger';\nimport type { ArtifactError } from '../../manager/types';\nimport { exec } from '../../util/exec';\nimport { readLocalFile, writeLocalFile } from '../../util/fs';\nimport { getRepoStatus } from '../../util/git';\nimport type { File } from '../../util/git/types';\nimport { regEx } from '../../util/regex';\nimport { sanitize } from '../../util/sanitize';\nimport { compile } from '../../util/template';\nimport type { BranchConfig, BranchUpgradeConfig } from '../types';\n\nexport type PostUpgradeCommandsExecutionResult = {\n  updatedArtifacts: File[];\n  artifactErrors: ArtifactError[];\n};\n\nexport async function postUpgradeCommandsExecutor(\n  filteredUpgradeCommands: BranchUpgradeConfig[],\n  config: BranchConfig\n): Promise<PostUpgradeCommandsExecutionResult> {\n  let updatedArtifacts = [...(config.updatedArtifacts || [])];\n  const artifactErrors = [...(config.artifactErrors || [])];\n  const { allowedPostUpgradeCommands, allowPostUpgradeCommandTemplating } =\n    GlobalConfig.get();\n\n  for (const upgrade of filteredUpgradeCommands) {\n    addMeta({ dep: upgrade.depName });\n    logger.trace(\n      {\n        tasks: upgrade.postUpgradeTasks,\n        allowedCommands: allowedPostUpgradeCommands,\n      },\n      `Checking for post-upgrade tasks`\n    );\n    const commands = upgrade.postUpgradeTasks?.commands || [];\n    const fileFilters = upgrade.postUpgradeTasks?.fileFilters || [];\n\n    if (is.nonEmptyArray(commands)) {\n      // Persist updated files in file system so any executed commands can see them\n      for (const file of config.updatedPackageFiles.concat(updatedArtifacts)) {\n        if (file.name !== '|delete|') {\n          let contents;\n          if (typeof file.contents === 'string') {\n            contents = Buffer.from(file.contents);\n          } else {\n            contents = file.contents;\n          }\n          await writeLocalFile(file.name, contents);\n        }\n      }\n\n      for (const cmd of commands) {\n        if (\n          allowedPostUpgradeCommands.some((pattern) => regEx(pattern).test(cmd))\n        ) {\n          try {\n            const compiledCmd = allowPostUpgradeCommandTemplating\n              ? compile(cmd, upgrade)\n              : cmd;\n\n            logger.debug({ cmd: compiledCmd }, 'Executing post-upgrade task');\n            const execResult = await exec(compiledCmd, {\n              cwd: GlobalConfig.get('localDir'),\n            });\n\n            logger.debug(\n              { cmd: compiledCmd, ...execResult },\n              'Executed post-upgrade task'\n            );\n          } catch (error) {\n            artifactErrors.push({\n              lockFile: upgrade.packageFile,\n              stderr: sanitize(error.message),\n            });\n          }\n        } else {\n          logger.warn(\n            {\n              cmd,\n              allowedPostUpgradeCommands,\n            },\n            'Post-upgrade task did not match any on allowed list'\n          );\n          artifactErrors.push({\n            lockFile: upgrade.packageFile,\n            stderr: sanitize(\n              `Post-upgrade command '${cmd}' does not match allowed pattern${\n                allowedPostUpgradeCommands.length === 1 ? '' : 's'\n              } ${allowedPostUpgradeCommands.map((x) => `'${x}'`).join(', ')}`\n            ),\n          });\n        }\n      }\n\n      const status = await getRepoStatus();\n\n      for (const relativePath of status.modified.concat(status.not_added)) {\n        for (const pattern of fileFilters) {\n          if (minimatch(relativePath, pattern)) {\n            logger.debug(\n              { file: relativePath, pattern },\n              'Post-upgrade file saved'\n            );\n            const existingContent = await readLocalFile(relativePath);\n            const existingUpdatedArtifacts = updatedArtifacts.find(\n              (ua) => ua.name === relativePath\n            );\n            if (existingUpdatedArtifacts) {\n              existingUpdatedArtifacts.contents = existingContent;\n            } else {\n              updatedArtifacts.push({\n                name: relativePath,\n                contents: existingContent,\n              });\n            }\n            // If the file is deleted by a previous post-update command, remove the deletion from updatedArtifacts\n            updatedArtifacts = updatedArtifacts.filter(\n              (ua) => ua.name !== '|delete|' || ua.contents !== relativePath\n            );\n          }\n        }\n      }\n\n      for (const relativePath of status.deleted || []) {\n        for (const pattern of fileFilters) {\n          if (minimatch(relativePath, pattern)) {\n            logger.debug(\n              { file: relativePath, pattern },\n              'Post-upgrade file removed'\n            );\n            updatedArtifacts.push({\n              name: '|delete|',\n              contents: relativePath,\n            });\n            // If the file is created or modified by a previous post-update command, remove the modification from updatedArtifacts\n            updatedArtifacts = updatedArtifacts.filter(\n              (ua) => ua.name !== relativePath\n            );\n          }\n        }\n      }\n    }\n  }\n  return { updatedArtifacts, artifactErrors };\n}\n\nexport default async function executePostUpgradeCommands(\n  config: BranchConfig\n): Promise<PostUpgradeCommandsExecutionResult | null> {\n  const { allowedPostUpgradeCommands } = GlobalConfig.get();\n\n  const hasChangedFiles =\n    config.updatedPackageFiles?.length > 0 ||\n    config.updatedArtifacts?.length > 0;\n\n  if (\n    /* Only run post-upgrade tasks if there are changes to package files... */\n    !hasChangedFiles ||\n    is.emptyArray(allowedPostUpgradeCommands)\n  ) {\n    return null;\n  }\n\n  const branchUpgradeCommands: BranchUpgradeConfig[] = [\n    {\n      depName: config.upgrades.map(({ depName }) => depName).join(' '),\n      branchName: config.branchName,\n      postUpgradeTasks:\n        config.postUpgradeTasks.executionMode === 'branch'\n          ? config.postUpgradeTasks\n          : undefined,\n      fileFilters: config.fileFilters,\n    },\n  ];\n\n  const updateUpgradeCommands: BranchUpgradeConfig[] = config.upgrades.filter(\n    ({ postUpgradeTasks }) =>\n      !postUpgradeTasks ||\n      !postUpgradeTasks.executionMode ||\n      postUpgradeTasks.executionMode === 'update'\n  );\n\n  const { updatedArtifacts, artifactErrors } =\n    await postUpgradeCommandsExecutor(updateUpgradeCommands, config);\n  return postUpgradeCommandsExecutor(branchUpgradeCommands, {\n    ...config,\n    updatedArtifacts,\n    artifactErrors,\n  });\n}\n"]}