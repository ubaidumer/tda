{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/datasource/aws-machine-image/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { DescribeImagesCommand, EC2Client, Image } from '@aws-sdk/client-ec2';\nimport { cache } from '../../util/cache/package/decorator';\nimport * as amazonMachineImageVersioning from '../../versioning/aws-machine-image';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, ReleaseResult } from '../types';\n\nexport class AwsMachineImageDataSource extends Datasource {\n  static readonly id = 'aws-machine-image';\n\n  override readonly defaultVersioning = amazonMachineImageVersioning.id;\n\n  override readonly caching = true;\n\n  override readonly defaultConfig = {\n    // Because AMIs don't follow any versioning scheme, we override commitMessageExtra to remove the 'v'\n    commitMessageExtra: 'to {{{newVersion}}}',\n    prBodyColumns: ['Change', 'Image'],\n    prBodyDefinitions: {\n      Image: '```{{{newDigest}}}```',\n    },\n    digest: {\n      // Because newDigestShort will allways be 'amazon-' we override to print the name of the AMI\n      commitMessageExtra: 'to {{{newDigest}}}',\n      prBodyColumns: ['Image'],\n      prBodyDefinitions: {\n        Image: '```{{{newDigest}}}```',\n      },\n    },\n  };\n\n  private readonly ec2: EC2Client;\n\n  private readonly now: number;\n\n  constructor() {\n    super(AwsMachineImageDataSource.id);\n    this.ec2 = new EC2Client({});\n    this.now = Date.now();\n  }\n\n  @cache({\n    namespace: `datasource-${AwsMachineImageDataSource.id}`,\n    key: (serializedAmiFilter: string) =>\n      `getSortedAwsMachineImages:${serializedAmiFilter}`,\n  })\n  async getSortedAwsMachineImages(\n    serializedAmiFilter: string\n  ): Promise<Image[]> {\n    const cmd = new DescribeImagesCommand({\n      Filters: JSON.parse(serializedAmiFilter),\n    });\n    const matchingImages = await this.ec2.send(cmd);\n    matchingImages.Images = matchingImages.Images ?? [];\n    return matchingImages.Images.sort(\n      (image1, image2) =>\n        Date.parse(image1.CreationDate) - Date.parse(image2.CreationDate)\n    );\n  }\n\n  @cache({\n    namespace: `datasource-${AwsMachineImageDataSource.id}`,\n    key: ({ registryUrl, lookupName }: GetReleasesConfig, newValue: string) =>\n      `getDigest:${registryUrl}:${lookupName}:${newValue ?? ''}`,\n  })\n  override async getDigest(\n    { lookupName: serializedAmiFilter }: GetReleasesConfig,\n    newValue?: string\n  ): Promise<string | null> {\n    const images = await this.getSortedAwsMachineImages(serializedAmiFilter);\n    if (images.length < 1) {\n      return null;\n    }\n\n    if (newValue) {\n      const newValueMatchingImages = images.filter(\n        (image) => image.ImageId === newValue\n      );\n      if (newValueMatchingImages.length === 1) {\n        return newValueMatchingImages[0].Name;\n      }\n      return null;\n    }\n\n    return (await this.getReleases({ lookupName: serializedAmiFilter }))\n      .releases[0].newDigest;\n  }\n\n  @cache({\n    namespace: `datasource-${AwsMachineImageDataSource.id}`,\n    key: ({ registryUrl, lookupName }: GetReleasesConfig) =>\n      `getReleases:${registryUrl}:${lookupName}`,\n  })\n  async getReleases({\n    lookupName: serializedAmiFilter,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const images = await this.getSortedAwsMachineImages(serializedAmiFilter);\n    if (images.length === 0) {\n      return null;\n    }\n    const latestImage = images[images.length - 1];\n    return {\n      releases: [\n        {\n          version: latestImage.ImageId,\n          releaseTimestamp: latestImage.CreationDate,\n          isDeprecated:\n            Date.parse(latestImage.DeprecationTime ?? this.now.toString()) <\n            this.now,\n          newDigest: latestImage.Name,\n        },\n      ],\n    };\n  }\n}\n"]}