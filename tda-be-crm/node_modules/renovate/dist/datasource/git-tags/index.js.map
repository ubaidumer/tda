{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/datasource/git-tags/index.ts"],"names":[],"mappings":";;;;AAAA,kEAA2D;AAC3D,4CAAyC;AACzC,6EAAkD;AAClD,8CAA2C;AAC3C,2CAAiD;AAGjD,MAAa,iBAAkB,SAAQ,uBAAU;IAG/C;QACE,KAAK,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAAC;QAGZ,0BAAqB,GAAG,KAAK,CAAC;IAFhD,CAAC;IAQD,KAAK,CAAC,WAAW,CAAC,EAChB,UAAU,GACQ;QAClB,MAAM,OAAO,GAAG,MAAM,oBAAa,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC;QAExE,IAAI,OAAO,KAAK,IAAI,EAAE;YACpB,OAAO,IAAI,CAAC;SACb;QACD,MAAM,QAAQ,GAAG,OAAO;aACrB,MAAM,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,IAAI,KAAK,MAAM,CAAC;aACpC,MAAM,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,MAAM,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;aAC5C,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;YACb,OAAO,EAAE,GAAG,CAAC,KAAK;YAClB,MAAM,EAAE,GAAG,CAAC,KAAK;YACjB,SAAS,EAAE,GAAG,CAAC,IAAI;SACpB,CAAC,CAAC,CAAC;QAEN,MAAM,SAAS,GAAG,UAAU;aACzB,OAAO,CAAC,IAAA,aAAK,EAAC,QAAQ,CAAC,EAAE,EAAE,CAAC;aAC5B,OAAO,CAAC,IAAA,aAAK,EAAC,KAAK,CAAC,EAAE,EAAE,CAAC,CAAC;QAE7B,MAAM,MAAM,GAAkB;YAC5B,SAAS;YACT,QAAQ;SACT,CAAC;QAEF,OAAO,MAAM,CAAC;IAChB,CAAC;IAEQ,KAAK,CAAC,SAAS,CACtB,EAAE,UAAU,EAAgB,EAC5B,QAAiB;QAEjB,MAAM,OAAO,GAAG,MAAM,oBAAa,CAAC,UAAU,CAAC,EAAE,UAAU,EAAE,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC;QACxE,MAAM,SAAS,GAAG,QAAQ,IAAI,MAAM,CAAC;QACrC,MAAM,GAAG,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,KAAK,KAAK,SAAS,CAAC,CAAC;QACjE,IAAI,GAAG,EAAE;YACP,OAAO,GAAG,CAAC,IAAI,CAAC;SACjB;QACD,OAAO,IAAI,CAAC;IACd,CAAC;;AApDe,oBAAE,GAAG,UAAU,CAAC;AAYhC;IAJC,IAAA,iBAAK,EAAC;QACL,SAAS,EAAE,cAAc,iBAAiB,CAAC,EAAE,EAAE;QAC/C,GAAG,EAAE,CAAC,EAAE,UAAU,EAAqB,EAAE,EAAE,CAAC,UAAU;KACvD,CAAC;oDA4BD;AAxCH,8CAsDC","sourcesContent":["import { cache } from '../../util/cache/package/decorator';\nimport { regEx } from '../../util/regex';\nimport * as semver from '../../versioning/semver';\nimport { Datasource } from '../datasource';\nimport { GitDatasource } from '../git-refs/base';\nimport type { DigestConfig, GetReleasesConfig, ReleaseResult } from '../types';\n\nexport class GitTagsDatasource extends Datasource {\n  static readonly id = 'git-tags';\n\n  constructor() {\n    super(GitTagsDatasource.id);\n  }\n\n  override readonly customRegistrySupport = false;\n\n  @cache({\n    namespace: `datasource-${GitTagsDatasource.id}`,\n    key: ({ lookupName }: GetReleasesConfig) => lookupName,\n  })\n  async getReleases({\n    lookupName,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const rawRefs = await GitDatasource.getRawRefs({ lookupName }, this.id);\n\n    if (rawRefs === null) {\n      return null;\n    }\n    const releases = rawRefs\n      .filter((ref) => ref.type === 'tags')\n      .filter((ref) => semver.isVersion(ref.value))\n      .map((ref) => ({\n        version: ref.value,\n        gitRef: ref.value,\n        newDigest: ref.hash,\n      }));\n\n    const sourceUrl = lookupName\n      .replace(regEx(/\\.git$/), '')\n      .replace(regEx(/\\/$/), '');\n\n    const result: ReleaseResult = {\n      sourceUrl,\n      releases,\n    };\n\n    return result;\n  }\n\n  override async getDigest(\n    { lookupName }: DigestConfig,\n    newValue?: string\n  ): Promise<string | null> {\n    const rawRefs = await GitDatasource.getRawRefs({ lookupName }, this.id);\n    const findValue = newValue || 'HEAD';\n    const ref = rawRefs.find((rawRef) => rawRef.value === findValue);\n    if (ref) {\n      return ref.hash;\n    }\n    return null;\n  }\n}\n"]}