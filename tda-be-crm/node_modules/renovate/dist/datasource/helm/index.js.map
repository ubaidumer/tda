{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/datasource/helm/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { load } from 'js-yaml';\nimport { logger } from '../../logger';\nimport { cache } from '../../util/cache/package/decorator';\nimport { ensureTrailingSlash } from '../../util/url';\nimport * as helmVersioning from '../../versioning/helm';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, ReleaseResult } from '../types';\nimport { findSourceUrl } from './common';\nimport type { HelmRepository, RepositoryData } from './types';\n\nexport class HelmDatasource extends Datasource {\n  static readonly id = 'helm';\n\n  constructor() {\n    super(HelmDatasource.id);\n  }\n\n  override readonly defaultRegistryUrls = ['https://charts.helm.sh/stable'];\n\n  override readonly defaultConfig = {\n    commitMessageTopic: 'Helm release {{depName}}',\n    group: {\n      commitMessageTopic: '{{{groupName}}} Helm releases',\n    },\n  };\n\n  override readonly defaultVersioning = helmVersioning.id;\n\n  @cache({\n    namespace: `datasource-${HelmDatasource.id}`,\n    key: (repository: string) => repository,\n  })\n  async getRepositoryData(repository: string): Promise<RepositoryData | null> {\n    let res: any;\n    try {\n      res = await this.http.get('index.yaml', {\n        baseUrl: ensureTrailingSlash(repository),\n      });\n      if (!res || !res.body) {\n        logger.warn(`Received invalid response from ${repository}`);\n        return null;\n      }\n    } catch (err) {\n      this.handleGenericErrors(err);\n    }\n    try {\n      const doc = load(res.body, {\n        json: true,\n      }) as HelmRepository;\n      if (!is.plainObject<HelmRepository>(doc)) {\n        logger.warn(`Failed to parse index.yaml from ${repository}`);\n        return null;\n      }\n      const result: RepositoryData = {};\n      for (const [name, releases] of Object.entries(doc.entries)) {\n        result[name] = {\n          homepage: releases[0].home,\n          sourceUrl: findSourceUrl(releases[0]),\n          releases: releases.map((release) => ({\n            version: release.version,\n            releaseTimestamp: release.created ?? null,\n          })),\n        };\n      }\n\n      return result;\n    } catch (err) {\n      logger.warn(`Failed to parse index.yaml from ${repository}`);\n      logger.debug(err);\n      return null;\n    }\n  }\n\n  async getReleases({\n    lookupName,\n    registryUrl: helmRepository,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const repositoryData = await this.getRepositoryData(helmRepository);\n    if (!repositoryData) {\n      logger.debug(`Couldn't get index.yaml file from ${helmRepository}`);\n      return null;\n    }\n    const releases = repositoryData[lookupName];\n    if (!releases) {\n      logger.debug(\n        { dependency: lookupName },\n        `Entry ${lookupName} doesn't exist in index.yaml from ${helmRepository}`\n      );\n      return null;\n    }\n    return releases;\n  }\n}\n"]}