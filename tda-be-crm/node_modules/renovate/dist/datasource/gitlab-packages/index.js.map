{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/datasource/gitlab-packages/index.ts"],"names":[],"mappings":";;;;AAAA,kEAA2D;AAC3D,mDAAoD;AACpD,wCAA8C;AAC9C,8CAA2C;AAE3C,qCAAsC;AAGtC,oEAAoE;AAEpE,MAAa,wBAAyB,SAAQ,uBAAU;IAWtD;QACE,KAAK,CAAC,mBAAU,CAAC,CAAC;QAPX,YAAO,GAAG,IAAI,CAAC;QAEf,0BAAqB,GAAG,IAAI,CAAC;QAE7B,wBAAmB,GAAG,CAAC,oBAAoB,CAAC,CAAC;QAIpD,IAAI,CAAC,IAAI,GAAG,IAAI,mBAAU,EAAE,CAAC;IAC/B,CAAC;IAED,MAAM,CAAC,sBAAsB,CAC3B,WAAmB,EACnB,WAAmB,EACnB,WAAmB;QAEnB,MAAM,kBAAkB,GAAG,kBAAkB,CAAC,WAAW,CAAC,CAAC;QAC3D,MAAM,kBAAkB,GAAG,kBAAkB,CAAC,WAAW,CAAC,CAAC;QAE3D,OAAO,IAAA,kBAAY,EACjB,WAAW,EACX,iBAAiB,EACjB,kBAAkB,EAClB,yBAAyB,kBAAkB,eAAe,CAC3D,CAAC;IACJ,CAAC;IAOD,KAAK,CAAC,WAAW,CAAC,EAChB,WAAW,EACX,UAAU,GACQ;;QAClB,MAAM,CAAC,WAAW,EAAE,WAAW,CAAC,GAAG,UAAU,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;QAE5D,MAAM,MAAM,GAAG,wBAAwB,CAAC,sBAAsB,CAC5D,WAAW,EACX,WAAW,EACX,WAAW,CACZ,CAAC;QAEF,MAAM,MAAM,GAAkB;YAC5B,QAAQ,EAAE,IAAI;SACf,CAAC;QAEF,IAAI,QAAyB,CAAC;QAC9B,IAAI;YACF,QAAQ,GAAG,CACT,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAkB,MAAM,EAAE,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC,CACrE,CAAC,IAAI,CAAC;YAEP,MAAM,CAAC,QAAQ,GAAG,QAAQ;gBACxB,sHAAsH;gBACtH,4FAA4F;iBAC3F,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,WAAW,CAAC;iBACrC,GAAG,CAAC,CAAC,EAAE,OAAO,EAAE,UAAU,EAAE,EAAE,EAAE,CAAC,CAAC;gBACjC,OAAO;gBACP,gBAAgB,EAAE,UAAU;aAC7B,CAAC,CAAC,CAAC;SACP;QAAC,OAAO,GAAG,EAAE;YACZ,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,CAAC;SAC/B;QAED,OAAO,CAAA,MAAA,MAAM,CAAC,QAAQ,0CAAE,MAAM,EAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC;IACjD,CAAC;;AAvEe,2BAAE,GAAG,mBAAU,CAAC;AAoChC;IALC,IAAA,iBAAK,EAAC;QACL,SAAS,EAAE,cAAc,mBAAU,EAAE;QACrC,GAAG,EAAE,CAAC,EAAE,WAAW,EAAE,UAAU,EAAqB,EAAE,EAAE,CACtD,GAAG,WAAW,IAAI,UAAU,EAAE;KACjC,CAAC;2DAoCD;AAxEH,4DAyEC","sourcesContent":["import { cache } from '../../util/cache/package/decorator';\nimport { GitlabHttp } from '../../util/http/gitlab';\nimport { joinUrlParts } from '../../util/url';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, ReleaseResult } from '../types';\nimport { datasource } from './common';\nimport type { GitlabPackage } from './types';\n\n// Gitlab Packages API: https://docs.gitlab.com/ee/api/packages.html\n\nexport class GitlabPackagesDatasource extends Datasource {\n  static readonly id = datasource;\n\n  protected override http: GitlabHttp;\n\n  override caching = true;\n\n  override customRegistrySupport = true;\n\n  override defaultRegistryUrls = ['https://gitlab.com'];\n\n  constructor() {\n    super(datasource);\n    this.http = new GitlabHttp();\n  }\n\n  static getGitlabPackageApiUrl(\n    registryUrl: string,\n    projectName: string,\n    packageName: string\n  ): string {\n    const projectNameEncoded = encodeURIComponent(projectName);\n    const packageNameEncoded = encodeURIComponent(packageName);\n\n    return joinUrlParts(\n      registryUrl,\n      `api/v4/projects`,\n      projectNameEncoded,\n      `packages?package_name=${packageNameEncoded}&per_page=100`\n    );\n  }\n\n  @cache({\n    namespace: `datasource-${datasource}`,\n    key: ({ registryUrl, lookupName }: GetReleasesConfig) =>\n      `${registryUrl}-${lookupName}`,\n  })\n  async getReleases({\n    registryUrl,\n    lookupName,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const [projectName, packageName] = lookupName.split(':', 2);\n\n    const apiUrl = GitlabPackagesDatasource.getGitlabPackageApiUrl(\n      registryUrl,\n      projectName,\n      packageName\n    );\n\n    const result: ReleaseResult = {\n      releases: null,\n    };\n\n    let response: GitlabPackage[];\n    try {\n      response = (\n        await this.http.getJson<GitlabPackage[]>(apiUrl, { paginate: true })\n      ).body;\n\n      result.releases = response\n        // Setting the package_name option when calling the GitLab API isn't enough to filter information about other packages\n        // because this option is only implemented on GitLab > 12.9 and it only does a fuzzy search.\n        .filter((r) => r.name === packageName)\n        .map(({ version, created_at }) => ({\n          version,\n          releaseTimestamp: created_at,\n        }));\n    } catch (err) {\n      this.handleGenericErrors(err);\n    }\n\n    return result.releases?.length ? result : null;\n  }\n}\n"]}