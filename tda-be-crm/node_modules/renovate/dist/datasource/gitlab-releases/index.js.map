{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/datasource/gitlab-releases/index.ts"],"names":[],"mappings":";;;;AAAA,kEAA2D;AAC3D,mDAAoD;AACpD,8CAA2C;AAI3C,MAAa,wBAAyB,SAAQ,uBAAU;IAOtD;QACE,KAAK,CAAC,wBAAwB,CAAC,EAAE,CAAC,CAAC;QALnB,wBAAmB,GAAG,CAAC,oBAAoB,CAAC,CAAC;QAM7D,IAAI,CAAC,IAAI,GAAG,IAAI,mBAAU,CAAC,wBAAwB,CAAC,EAAE,CAAC,CAAC;IAC1D,CAAC;IAOD,KAAK,CAAC,WAAW,CAAC,EAChB,WAAW,EACX,UAAU,GACQ;QAClB,MAAM,cAAc,GAAG,kBAAkB,CAAC,UAAU,CAAC,CAAC;QACtD,MAAM,MAAM,GAAG,GAAG,WAAW,oBAAoB,cAAc,WAAW,CAAC;QAE3E,IAAI;YACF,MAAM,sBAAsB,GAAG,CAC7B,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAkB,MAAM,CAAC,CACjD,CAAC,IAAI,CAAC;YAEP,OAAO;gBACL,SAAS,EAAE,GAAG,WAAW,IAAI,UAAU,EAAE;gBACzC,QAAQ,EAAE,sBAAsB,CAAC,GAAG,CAAC,CAAC,EAAE,QAAQ,EAAE,WAAW,EAAE,EAAE,EAAE;oBACjE,MAAM,OAAO,GAAY;wBACvB,WAAW;wBACX,MAAM,EAAE,QAAQ;wBAChB,OAAO,EAAE,QAAQ;wBACjB,gBAAgB,EAAE,WAAW;qBAC9B,CAAC;oBACF,OAAO,OAAO,CAAC;gBACjB,CAAC,CAAC;aACH,CAAC;SACH;QAAC,OAAO,CAAC,EAAE;YACV,IAAI,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC;SAC7B;QACD,0BAA0B;QAC1B,OAAO,IAAI,CAAC;IACd,CAAC;;AA7Ce,2BAAE,GAAG,iBAAiB,CAAC;AAIvB,yCAAgB,GAAG,OAAO,CAAC;AAY3C;IALC,IAAA,iBAAK,EAAC;QACL,SAAS,EAAE,cAAc,wBAAwB,CAAC,EAAE,EAAE;QACtD,GAAG,EAAE,CAAC,EAAE,WAAW,EAAE,UAAU,EAAqB,EAAE,EAAE,CACtD,GAAG,WAAW,IAAI,UAAU,EAAE;KACjC,CAAC;2DA8BD;AA9CH,4DA+CC","sourcesContent":["import { cache } from '../../util/cache/package/decorator';\nimport { GitlabHttp } from '../../util/http/gitlab';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, Release, ReleaseResult } from '../types';\nimport type { GitlabRelease } from './types';\n\nexport class GitlabReleasesDatasource extends Datasource {\n  static readonly id = 'gitlab-releases';\n\n  override readonly defaultRegistryUrls = ['https://gitlab.com'];\n\n  static readonly registryStrategy = 'first';\n\n  constructor() {\n    super(GitlabReleasesDatasource.id);\n    this.http = new GitlabHttp(GitlabReleasesDatasource.id);\n  }\n\n  @cache({\n    namespace: `datasource-${GitlabReleasesDatasource.id}`,\n    key: ({ registryUrl, lookupName }: GetReleasesConfig) =>\n      `${registryUrl}/${lookupName}`,\n  })\n  async getReleases({\n    registryUrl,\n    lookupName,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    const urlEncodedRepo = encodeURIComponent(lookupName);\n    const apiUrl = `${registryUrl}/api/v4/projects/${urlEncodedRepo}/releases`;\n\n    try {\n      const gitlabReleasesResponse = (\n        await this.http.getJson<GitlabRelease[]>(apiUrl)\n      ).body;\n\n      return {\n        sourceUrl: `${registryUrl}/${lookupName}`,\n        releases: gitlabReleasesResponse.map(({ tag_name, released_at }) => {\n          const release: Release = {\n            registryUrl,\n            gitRef: tag_name,\n            version: tag_name,\n            releaseTimestamp: released_at,\n          };\n          return release;\n        }),\n      };\n    } catch (e) {\n      this.handleGenericErrors(e);\n    }\n    /* istanbul ignore next */\n    return null;\n  }\n}\n"]}