{"version":3,"file":"index.js","sourceRoot":"","sources":["../../lib/platform/index.ts"],"names":[],"mappings":"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","sourcesContent":["import URL from 'url';\nimport type { AllConfig } from '../config/types';\nimport { PLATFORM_NOT_FOUND } from '../constants/error-messages';\nimport { logger } from '../logger';\nimport type { HostRule } from '../types';\nimport { setGitAuthor, setNoVerify, setPrivateKey } from '../util/git';\nimport * as hostRules from '../util/host-rules';\nimport platforms from './api';\nimport type { Platform } from './types';\n\nexport * from './types';\n\nexport const getPlatformList = (): string[] => Array.from(platforms.keys());\nexport const getPlatforms = (): Map<string, Platform> => platforms;\n\nlet _platform: Platform;\n\nconst handler: ProxyHandler<Platform> = {\n  get(_target: Platform, prop: keyof Platform) {\n    if (!_platform) {\n      throw new Error(PLATFORM_NOT_FOUND);\n    }\n    return _platform[prop];\n  },\n};\n\nexport const platform = new Proxy<Platform>({} as any, handler);\n\nexport function setPlatformApi(name: string): void {\n  if (!platforms.has(name)) {\n    throw new Error(\n      `Init: Platform \"${name}\" not found. Must be one of: ${getPlatformList().join(\n        ', '\n      )}`\n    );\n  }\n  _platform = platforms.get(name);\n}\n\nexport async function initPlatform(config: AllConfig): Promise<AllConfig> {\n  setPrivateKey(config.gitPrivateKey);\n  setNoVerify(config.gitNoVerify ?? []);\n  setPlatformApi(config.platform);\n  // TODO: types\n  const platformInfo = await platform.initPlatform(config);\n  const returnConfig: any = { ...config, ...platformInfo };\n  // istanbul ignore else\n  if (config?.gitAuthor) {\n    logger.debug(`Using configured gitAuthor (${config.gitAuthor})`);\n    returnConfig.gitAuthor = config.gitAuthor;\n  } else if (platformInfo?.gitAuthor) {\n    logger.debug(`Using platform gitAuthor: ${String(platformInfo.gitAuthor)}`);\n    returnConfig.gitAuthor = platformInfo.gitAuthor;\n  }\n  // This is done for validation and will be overridden later once repo config is incorporated\n  setGitAuthor(returnConfig.gitAuthor);\n  const platformRule: HostRule = {\n    matchHost: URL.parse(returnConfig.endpoint).hostname,\n  };\n  ['token', 'username', 'password'].forEach((field) => {\n    if (config[field]) {\n      platformRule[field] = config[field];\n      delete returnConfig[field];\n    }\n  });\n  returnConfig.hostRules = returnConfig.hostRules || [];\n  const typedPlatformRule = {\n    ...platformRule,\n    hostType: returnConfig.platform,\n  };\n  returnConfig.hostRules.push(typedPlatformRule);\n  hostRules.add(typedPlatformRule);\n  return returnConfig;\n}\n"]}