{"version":3,"file":"range.js","sourceRoot":"","sources":["../../../lib/versioning/pep440/range.ts"],"names":[],"mappings":"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","sourcesContent":["import { gte, lt, lte, satisfies } from '@renovate/pep440';\nimport { parse as parseRange } from '@renovate/pep440/lib/specifier';\nimport { parse as parseVersion } from '@renovate/pep440/lib/version';\nimport { logger } from '../../logger';\nimport { regEx } from '../../util/regex';\nimport type { NewValueConfig } from '../types';\n\nfunction getFutureVersion(\n  baseVersion: string,\n  newVersion: string,\n  step: number\n): string {\n  const toRelease: number[] = parseVersion(newVersion).release;\n  const baseRelease: number[] = parseVersion(baseVersion).release;\n  let found = false;\n  const futureRelease = baseRelease.map((basePart, index) => {\n    if (found) {\n      return 0;\n    }\n    const toPart = toRelease[index] || 0;\n    if (toPart > basePart) {\n      found = true;\n      return toPart + step;\n    }\n    return toPart;\n  });\n  if (!found) {\n    futureRelease[futureRelease.length - 1] += step;\n  }\n  return futureRelease.join('.');\n}\n\ninterface Range {\n  operator: string;\n  prefix: string;\n  version: string;\n}\n\nexport function getNewValue({\n  currentValue,\n  rangeStrategy,\n  currentVersion,\n  newVersion,\n}: NewValueConfig): string {\n  // easy pin\n  if (rangeStrategy === 'pin') {\n    return '==' + newVersion;\n  }\n  if (currentValue === currentVersion) {\n    return newVersion;\n  }\n  const ranges: Range[] = parseRange(currentValue);\n  if (!ranges) {\n    logger.warn({ currentValue }, 'Invalid pep440 currentValue');\n    return null;\n  }\n  if (!ranges.length) {\n    // an empty string is an allowed value for PEP440 range\n    // it means get any version\n    logger.warn('Empty currentValue: ' + currentValue);\n    return currentValue;\n  }\n  if (rangeStrategy === 'auto' || rangeStrategy === 'replace') {\n    if (satisfies(newVersion, currentValue)) {\n      return currentValue;\n    }\n  }\n  if (!['replace', 'bump'].includes(rangeStrategy)) {\n    logger.debug(\n      'Unsupported rangeStrategy: ' +\n        rangeStrategy +\n        '. Using \"replace\" instead.'\n    );\n    return getNewValue({\n      currentValue,\n      rangeStrategy: 'replace',\n      currentVersion,\n      newVersion,\n    });\n  }\n  if (ranges.some((range) => range.operator === '===')) {\n    // the operator \"===\" is used for legacy non PEP440 versions\n    logger.warn(\n      { currentValue },\n      'PEP440 arbitrary equality (===) not supported'\n    );\n    return null;\n  }\n  let result = ranges\n    .map((range) => {\n      // used to exclude versions,\n      // we assume that's for a good reason\n      if (range.operator === '!=') {\n        return range.operator + range.version;\n      }\n\n      // used to mark minimum supported version\n      if (['>', '>='].includes(range.operator)) {\n        if (lte(newVersion, range.version)) {\n          // this looks like a rollback\n          return '>=' + newVersion;\n        }\n        // this is similar to ~=\n        if (rangeStrategy === 'bump' && range.operator === '>=') {\n          return range.operator + newVersion;\n        }\n        // otherwise treat it same as exclude\n        return range.operator + range.version;\n      }\n\n      // this is used to exclude future versions\n      if (range.operator === '<') {\n        // if newVersion is that future version\n        if (gte(newVersion, range.version)) {\n          // now here things get tricky\n          // we calculate the new future version\n          const futureVersion = getFutureVersion(range.version, newVersion, 1);\n          return range.operator + futureVersion;\n        }\n        // otherwise treat it same as exclude\n        return range.operator + range.version;\n      }\n\n      // keep the .* suffix\n      if (range.prefix) {\n        const futureVersion = getFutureVersion(range.version, newVersion, 0);\n        return range.operator + futureVersion + '.*';\n      }\n\n      if (['==', '~=', '<='].includes(range.operator)) {\n        return range.operator + newVersion;\n      }\n\n      // unless PEP440 changes, this won't happen\n      // istanbul ignore next\n      logger.error(\n        { newVersion, currentValue, range },\n        'pep440: failed to process range'\n      );\n      // istanbul ignore next\n      return null;\n    })\n    .filter(Boolean)\n    .join(', ');\n\n  if (result.includes(', ') && !currentValue.includes(', ')) {\n    result = result.replace(regEx(/, /g), ',');\n  }\n\n  if (!satisfies(newVersion, result)) {\n    // we failed at creating the range\n    logger.warn(\n      { result, newVersion, currentValue },\n      'pep440: failed to calculate newValue'\n    );\n    return null;\n  }\n\n  return result;\n}\n\nexport function isLessThanRange(input: string, range: string): boolean {\n  try {\n    let invertResult = true;\n\n    const results = range\n      .split(',')\n      .map((x) =>\n        x\n          .replace(regEx(/\\s*/g), '') // TODO #12071\n          .split(regEx(/(~=|==|!=|<=|>=|<|>|===)/)) // TODO #12071\n          .slice(1)\n      )\n      .map(([op, version]) => {\n        if (['!=', '<=', '<'].includes(op)) {\n          return true;\n        }\n        invertResult = false;\n        if (['~=', '==', '>=', '==='].includes(op)) {\n          return lt(input, version);\n        }\n        if (op === '>') {\n          return lte(input, version);\n        }\n        // istanbul ignore next\n        return false;\n      });\n\n    const result = results.every((res) => res === true);\n\n    return invertResult ? !result : result;\n  } catch (err) /* istanbul ignore next */ {\n    return false;\n  }\n}\n"]}