"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.removeAuthorization = exports.applyAuthorization = void 0;
const tslib_1 = require("tslib");
const is_1 = (0, tslib_1.__importDefault)(require("@sindresorhus/is"));
const constants_1 = require("../../constants");
function applyAuthorization(inOptions) {
    var _a, _b, _c;
    const options = { ...inOptions };
    if (((_a = options.headers) === null || _a === void 0 ? void 0 : _a.authorization) || options.noAuth) {
        return options;
    }
    if (options.token) {
        if (options.hostType === "gitea" /* Gitea */) {
            options.headers.authorization = `token ${options.token}`;
        }
        else if (constants_1.GITHUB_API_USING_HOST_TYPES.includes(options.hostType)) {
            options.headers.authorization = `token ${options.token}`;
            if (options.token.startsWith('x-access-token:')) {
                const appToken = options.token.replace('x-access-token:', '');
                options.headers.authorization = `token ${appToken}`;
                if (is_1.default.string(options.headers.accept)) {
                    options.headers.accept = options.headers.accept.replace('application/vnd.github.v3+json', 'application/vnd.github.machine-man-preview+json');
                }
            }
        }
        else if (constants_1.GITLAB_API_USING_HOST_TYPES.includes(options.hostType)) {
            // GitLab versions earlier than 12.2 only support authentication with
            // a personal access token, which is 20 characters long.
            if (options.token.length === 20) {
                options.headers['Private-token'] = options.token;
            }
            else {
                options.headers.authorization = `Bearer ${options.token}`;
            }
        }
        else {
            // Custom Auth type, eg `Basic XXXX_TOKEN`
            const type = (_c = (_b = options.context) === null || _b === void 0 ? void 0 : _b.authType) !== null && _c !== void 0 ? _c : 'Bearer';
            if (type === 'Token-Only') {
                options.headers.authorization = options.token;
            }
            else {
                options.headers.authorization = `${type} ${options.token}`;
            }
        }
        delete options.token;
    }
    else if (options.password !== undefined) {
        // Otherwise got will add username and password to url and header
        const auth = Buffer.from(`${options.username || ''}:${options.password}`).toString('base64');
        options.headers.authorization = `Basic ${auth}`;
        delete options.username;
        delete options.password;
    }
    return options;
}
exports.applyAuthorization = applyAuthorization;
// isAmazon return true if request options contains Amazon related headers
function isAmazon(options) {
    var _a;
    return (_a = options.search) === null || _a === void 0 ? void 0 : _a.includes('X-Amz-Algorithm');
}
// isAzureBlob return true if request options contains Azure container registry related data
function isAzureBlob(options) {
    var _a, _b;
    return (((_a = options.hostname) === null || _a === void 0 ? void 0 : _a.endsWith('.blob.core.windows.net')) && // lgtm [js/incomplete-url-substring-sanitization]
        ((_b = options.href) === null || _b === void 0 ? void 0 : _b.includes('/docker/registry')));
}
// removeAuthorization from the redirect options
function removeAuthorization(options) {
    var _a;
    if (!options.password && !((_a = options.headers) === null || _a === void 0 ? void 0 : _a.authorization)) {
        return;
    }
    // Check if request has been redirected to Amazon or an Azure blob (ACR)
    if (isAmazon(options) || isAzureBlob(options)) {
        // if there is no port in the redirect URL string, then delete it from the redirect options.
        // This can be evaluated for removal after upgrading to Got v10
        const portInUrl = options.href.split('/')[2].split(':')[1];
        // istanbul ignore next
        if (!portInUrl) {
            delete options.port; // Redirect will instead use 80 or 443 for HTTP or HTTPS respectively
        }
        // registry is hosted on Amazon or Azure blob, redirect url includes
        // authentication which is not required and should be removed
        delete options.headers.authorization;
        delete options.username;
        delete options.password;
    }
}
exports.removeAuthorization = removeAuthorization;
//# sourceMappingURL=auth.js.map