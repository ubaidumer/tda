{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../lib/util/fs/index.ts"],"names":[],"mappings":"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","sourcesContent":["import stream from 'stream';\nimport util from 'util';\nimport is from '@sindresorhus/is';\nimport * as fs from 'fs-extra';\nimport { isAbsolute, join, parse } from 'upath';\nimport { GlobalConfig } from '../../config/global';\nimport { logger } from '../../logger';\n\nexport * from './proxies';\n\nexport const pipeline = util.promisify(stream.pipeline);\n\nexport function getSubDirectory(fileName: string): string {\n  return parse(fileName).dir;\n}\n\nexport function getSiblingFileName(\n  existingFileNameWithPath: string,\n  otherFileName: string\n): string {\n  const subDirectory = getSubDirectory(existingFileNameWithPath);\n  return join(subDirectory, otherFileName);\n}\n\nexport async function readLocalFile(fileName: string): Promise<Buffer>;\nexport async function readLocalFile(\n  fileName: string,\n  encoding: 'utf8'\n): Promise<string>;\nexport async function readLocalFile(\n  fileName: string,\n  encoding?: string\n): Promise<string | Buffer | null> {\n  const { localDir } = GlobalConfig.get();\n  const localFileName = join(localDir, fileName);\n  try {\n    const fileContent = encoding\n      ? await fs.readFile(localFileName, encoding)\n      : await fs.readFile(localFileName);\n    return fileContent;\n  } catch (err) {\n    logger.trace({ err }, 'Error reading local file');\n    return null;\n  }\n}\n\nexport async function writeLocalFile(\n  fileName: string,\n  fileContent: string\n): Promise<void> {\n  const { localDir } = GlobalConfig.get();\n  const localFileName = join(localDir, fileName);\n  await fs.outputFile(localFileName, fileContent);\n}\n\nexport async function deleteLocalFile(fileName: string): Promise<void> {\n  const { localDir } = GlobalConfig.get();\n  if (localDir) {\n    const localFileName = join(localDir, fileName);\n    await fs.remove(localFileName);\n  }\n}\n\n// istanbul ignore next\nexport async function renameLocalFile(\n  fromFile: string,\n  toFile: string\n): Promise<void> {\n  const { localDir } = GlobalConfig.get();\n  await fs.move(join(localDir, fromFile), join(localDir, toFile));\n}\n\n// istanbul ignore next\nexport async function ensureDir(dirName: string): Promise<void> {\n  if (is.nonEmptyString(dirName)) {\n    await fs.ensureDir(dirName);\n  }\n}\n\n// istanbul ignore next\nexport async function ensureLocalDir(dirName: string): Promise<void> {\n  const { localDir } = GlobalConfig.get();\n  const localDirName = join(localDir, dirName);\n  await fs.ensureDir(localDirName);\n}\n\nexport async function ensureCacheDir(name: string): Promise<string> {\n  const cacheDirName = join(GlobalConfig.get('cacheDir'), `others/${name}`);\n  await fs.ensureDir(cacheDirName);\n  return cacheDirName;\n}\n\n/**\n * Return the path of the private cache directory. This directory is wiped\n * between repositories, so they can be used to store private registries' index\n * without risk of that information leaking to other repositories/users.\n */\nexport function privateCacheDir(): string {\n  const { cacheDir } = GlobalConfig.get();\n  return join(cacheDir, '__renovate-private-cache');\n}\n\nexport function localPathExists(pathName: string): Promise<boolean> {\n  const { localDir } = GlobalConfig.get();\n  // Works for both files as well as directories\n  return fs\n    .stat(join(localDir, pathName))\n    .then((s) => !!s)\n    .catch(() => false);\n}\n\n/**\n * Tries to find `otherFileName` in the directory where\n * `existingFileNameWithPath` is, then in its parent directory, then in the\n * grandparent, until we reach the top-level directory. All paths\n * must be relative to `localDir`.\n */\nexport async function findLocalSiblingOrParent(\n  existingFileNameWithPath: string,\n  otherFileName: string\n): Promise<string | null> {\n  if (isAbsolute(existingFileNameWithPath)) {\n    return null;\n  }\n  if (isAbsolute(otherFileName)) {\n    return null;\n  }\n\n  let current = existingFileNameWithPath;\n  while (current !== '') {\n    current = getSubDirectory(current);\n    const candidate = join(current, otherFileName);\n    if (await localPathExists(candidate)) {\n      return candidate;\n    }\n  }\n\n  return null;\n}\n\n/**\n * Get files by name from directory\n */\nexport async function readLocalDirectory(path: string): Promise<string[]> {\n  const { localDir } = GlobalConfig.get();\n  const localPath = join(localDir, path);\n  const fileList = await fs.readdir(localPath);\n  return fileList;\n}\n\nexport function createWriteStream(path: string): fs.WriteStream {\n  return fs.createWriteStream(path);\n}\n"]}