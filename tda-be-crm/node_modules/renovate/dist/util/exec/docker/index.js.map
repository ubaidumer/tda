{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/util/exec/docker/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { GlobalConfig } from '../../../config/global';\nimport { SYSTEM_INSUFFICIENT_MEMORY } from '../../../constants/error-messages';\nimport { getPkgReleases } from '../../../datasource';\nimport { logger } from '../../../logger';\nimport * as versioning from '../../../versioning';\nimport { regEx } from '../../regex';\nimport { ensureTrailingSlash } from '../../url';\nimport {\n  DockerOptions,\n  Opt,\n  VolumeOption,\n  VolumesPair,\n  rawExec,\n} from '../common';\n\nconst prefetchedImages = new Set<string>();\n\nexport async function prefetchDockerImage(taggedImage: string): Promise<void> {\n  if (prefetchedImages.has(taggedImage)) {\n    logger.debug(`Docker image is already prefetched: ${taggedImage}`);\n  } else {\n    logger.debug(`Fetching Docker image: ${taggedImage}`);\n    prefetchedImages.add(taggedImage);\n    await rawExec(`docker pull ${taggedImage}`, { encoding: 'utf-8' });\n    logger.debug(`Finished fetching Docker image`);\n  }\n}\n\nexport function resetPrefetchedImages(): void {\n  prefetchedImages.clear();\n}\n\nfunction expandVolumeOption(x: VolumeOption): VolumesPair | null {\n  if (is.nonEmptyString(x)) {\n    return [x, x];\n  }\n  if (Array.isArray(x) && x.length === 2) {\n    const [from, to] = x;\n    if (is.nonEmptyString(from) && is.nonEmptyString(to)) {\n      return [from, to];\n    }\n  }\n  return null;\n}\n\nfunction volumesEql(x: VolumesPair, y: VolumesPair): boolean {\n  const [xFrom, xTo] = x;\n  const [yFrom, yTo] = y;\n  return xFrom === yFrom && xTo === yTo;\n}\n\nfunction uniq<T = unknown>(\n  array: T[],\n  eql = (x: T, y: T): boolean => x === y\n): T[] {\n  return array.filter((x, idx, arr) => arr.findIndex((y) => eql(x, y)) === idx);\n}\n\nfunction prepareVolumes(volumes: VolumeOption[] = []): string[] {\n  const expanded: (VolumesPair | null)[] = volumes.map(expandVolumeOption);\n  const filtered: VolumesPair[] = expanded.filter((vol) => vol !== null);\n  const unique: VolumesPair[] = uniq<VolumesPair>(filtered, volumesEql);\n  return unique.map(([from, to]) => `-v \"${from}\":\"${to}\"`);\n}\n\nfunction prepareCommands(commands: Opt<string>[]): string[] {\n  return commands.filter((command) => command && typeof command === 'string');\n}\n\nexport async function getDockerTag(\n  depName: string,\n  constraint: string,\n  scheme: string\n): Promise<string> {\n  const ver = versioning.get(scheme);\n\n  if (!ver.isValid(constraint)) {\n    logger.warn(\n      { scheme, constraint },\n      `Invalid Docker image version constraint`\n    );\n    return 'latest';\n  }\n\n  logger.debug(\n    { depName, scheme, constraint },\n    `Found version constraint - checking for a compatible image to use`\n  );\n  const imageReleases = await getPkgReleases({\n    datasource: 'docker',\n    depName,\n    versioning: scheme,\n  });\n  if (imageReleases?.releases) {\n    let versions = imageReleases.releases.map((release) => release.version);\n    versions = versions.filter(\n      (version) => ver.isVersion(version) && ver.matches(version, constraint)\n    );\n    // Prefer stable versions over unstable, even if the range satisfies both types\n    if (!versions.every((version) => ver.isStable(version))) {\n      logger.debug('Filtering out unstable versions');\n      versions = versions.filter((version) => ver.isStable(version));\n    }\n    versions = versions.sort(ver.sortVersions.bind(ver));\n    if (versions.length) {\n      const version = versions.pop();\n      logger.debug(\n        { depName, scheme, constraint, version },\n        `Found compatible image version`\n      );\n      return version;\n    }\n  } else {\n    logger.error(`No ${depName} releases found`);\n    return 'latest';\n  }\n  logger.warn(\n    { depName, constraint, scheme },\n    'Failed to find a tag satisfying constraint, using \"latest\" tag instead'\n  );\n  return 'latest';\n}\n\nfunction getContainerName(image: string, prefix?: string): string {\n  return `${prefix || 'renovate_'}${image}`.replace(regEx(/\\//g), '_');\n}\n\nfunction getContainerLabel(prefix: string): string {\n  return `${prefix || 'renovate_'}child`;\n}\n\nexport async function removeDockerContainer(\n  image: string,\n  prefix: string\n): Promise<void> {\n  const containerName = getContainerName(image, prefix);\n  let cmd = `docker ps --filter name=${containerName} -aq`;\n  try {\n    const res = await rawExec(cmd, {\n      encoding: 'utf-8',\n    });\n    const containerId = res?.stdout?.trim() || '';\n    if (containerId.length) {\n      logger.debug({ containerId }, 'Removing container');\n      cmd = `docker rm -f ${containerId}`;\n      await rawExec(cmd, {\n        encoding: 'utf-8',\n      });\n    } else {\n      logger.trace({ image, containerName }, 'No running containers to remove');\n    }\n  } catch (err) {\n    logger.warn(\n      { image, containerName, cmd, err },\n      'Could not remove Docker container'\n    );\n  }\n}\n\nexport async function removeDanglingContainers(): Promise<void> {\n  const { binarySource, dockerChildPrefix } = GlobalConfig.get();\n  if (binarySource !== 'docker') {\n    return;\n  }\n\n  try {\n    const containerLabel = getContainerLabel(dockerChildPrefix);\n    const res = await rawExec(\n      `docker ps --filter label=${containerLabel} -aq`,\n      {\n        encoding: 'utf-8',\n      }\n    );\n    if (res?.stdout?.trim().length) {\n      const containerIds = res.stdout\n        .trim()\n        .split('\\n')\n        .map((container) => container.trim())\n        .filter(Boolean);\n      logger.debug({ containerIds }, 'Removing dangling child containers');\n      await rawExec(`docker rm -f ${containerIds.join(' ')}`, {\n        encoding: 'utf-8',\n      });\n    } else {\n      logger.debug('No dangling containers to remove');\n    }\n  } catch (err) {\n    if (err.errno === 'ENOMEM') {\n      throw new Error(SYSTEM_INSUFFICIENT_MEMORY);\n    }\n    if (err.stderr?.includes('Cannot connect to the Docker daemon')) {\n      logger.info('No docker daemon found');\n    } else {\n      logger.warn({ err }, 'Error removing dangling containers');\n    }\n  }\n}\n\nexport async function generateDockerCommand(\n  commands: string[],\n  options: DockerOptions\n): Promise<string> {\n  const { envVars, cwd, tagScheme, tagConstraint } = options;\n  let image = options.image;\n  const volumes = options.volumes || [];\n  const preCommands = options.preCommands || [];\n  const postCommands = options.postCommands || [];\n  const {\n    localDir,\n    cacheDir,\n    dockerUser,\n    dockerChildPrefix,\n    dockerImagePrefix,\n  } = GlobalConfig.get();\n  const result = ['docker run --rm'];\n  const containerName = getContainerName(image, dockerChildPrefix);\n  const containerLabel = getContainerLabel(dockerChildPrefix);\n  result.push(`--name=${containerName}`);\n  result.push(`--label=${containerLabel}`);\n  if (dockerUser) {\n    result.push(`--user=${dockerUser}`);\n  }\n\n  result.push(...prepareVolumes([localDir, cacheDir, ...volumes]));\n\n  if (envVars) {\n    result.push(\n      ...uniq(envVars)\n        .filter((x) => typeof x === 'string')\n        .map((e) => `-e ${e}`)\n    );\n  }\n\n  if (cwd) {\n    result.push(`-w \"${cwd}\"`);\n  }\n\n  image = `${ensureTrailingSlash(dockerImagePrefix ?? 'renovate')}${image}`;\n\n  let tag: string;\n  if (options.tag) {\n    tag = options.tag;\n  } else if (tagConstraint) {\n    const tagVersioning = tagScheme || 'semver';\n    tag = await getDockerTag(image, tagConstraint, tagVersioning);\n    logger.debug(\n      { image, tagConstraint, tagVersioning, tag },\n      'Resolved tag constraint'\n    );\n  } else {\n    logger.debug({ image }, 'No tag or tagConstraint specified');\n  }\n\n  const taggedImage = tag ? `${image}:${tag}` : `${image}`;\n  await prefetchDockerImage(taggedImage);\n  result.push(taggedImage);\n\n  const bashCommand = [\n    ...prepareCommands(preCommands),\n    ...commands,\n    ...prepareCommands(postCommands),\n  ].join(' && ');\n  result.push(`bash -l -c \"${bashCommand.replace(regEx(/\"/g), '\\\\\"')}\"`); // lgtm [js/incomplete-sanitization]\n\n  return result.join(' ');\n}\n"]}