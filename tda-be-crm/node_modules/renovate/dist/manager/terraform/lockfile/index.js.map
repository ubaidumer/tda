{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/manager/terraform/lockfile/index.ts"],"names":[],"mappings":"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","sourcesContent":["import pMap from 'p-map';\nimport { GetPkgReleasesConfig, getPkgReleases } from '../../../datasource';\nimport { TerraformProviderDatasource } from '../../../datasource/terraform-provider';\nimport { logger } from '../../../logger';\nimport { get as getVersioning } from '../../../versioning';\nimport type { UpdateArtifact, UpdateArtifactsResult } from '../../types';\nimport { massageProviderLookupName } from '../util';\nimport { TerraformProviderHash } from './hash';\nimport type { ProviderLock, ProviderLockUpdate } from './types';\nimport {\n  extractLocks,\n  findLockFile,\n  isPinnedVersion,\n  readLockFile,\n  writeLockUpdates,\n} from './util';\n\nasync function updateAllLocks(\n  locks: ProviderLock[]\n): Promise<ProviderLockUpdate[]> {\n  const updates = await pMap(\n    locks,\n    async (lock) => {\n      const updateConfig: GetPkgReleasesConfig = {\n        versioning: 'hashicorp',\n        datasource: 'terraform-provider',\n        depName: lock.lookupName,\n      };\n      const { releases } = await getPkgReleases(updateConfig);\n      const versioning = getVersioning(updateConfig.versioning);\n      const versionsList = releases.map((release) => release.version);\n      const newVersion = versioning.getSatisfyingVersion(\n        versionsList,\n        lock.constraints\n      );\n\n      // if the new version is the same as the last, signal that no update is needed\n      if (newVersion === lock.version) {\n        return null;\n      }\n      const update: ProviderLockUpdate = {\n        newVersion,\n        newConstraint: lock.constraints,\n        newHashes: await TerraformProviderHash.createHashes(\n          lock.registryUrl,\n          lock.lookupName,\n          newVersion\n        ),\n        ...lock,\n      };\n      return update;\n    },\n    { concurrency: 4 } // allow to look up 4 lock in parallel\n  );\n\n  return updates.filter(Boolean);\n}\n\nexport async function updateArtifacts({\n  packageFileName,\n  updatedDeps,\n  config,\n}: UpdateArtifact): Promise<UpdateArtifactsResult[] | null> {\n  logger.debug(`terraform.updateArtifacts(${packageFileName})`);\n\n  const lockFilePath = findLockFile(packageFileName);\n  try {\n    const lockFileContent = await readLockFile(lockFilePath);\n    if (!lockFileContent) {\n      logger.debug('No .terraform.lock.hcl found');\n      return null;\n    }\n    const locks = extractLocks(lockFileContent);\n    if (!locks) {\n      logger.debug('No Locks in .terraform.lock.hcl found');\n      return null;\n    }\n\n    const updates: ProviderLockUpdate[] = [];\n    if (config.updateType === 'lockFileMaintenance') {\n      // update all locks in the file during maintenance --> only update version in constraints\n      const maintenanceUpdates = await updateAllLocks(locks);\n      updates.push(...maintenanceUpdates);\n    } else {\n      const providerDeps = updatedDeps.filter((dep) =>\n        ['provider', 'required_provider'].includes(dep.depType)\n      );\n      for (const dep of providerDeps) {\n        massageProviderLookupName(dep);\n        const { registryUrls, newVersion, newValue, lookupName } = dep;\n\n        const registryUrl = registryUrls\n          ? registryUrls[0]\n          : TerraformProviderDatasource.defaultRegistryUrls[0];\n        const newConstraint = isPinnedVersion(newValue) ? newVersion : newValue;\n        const updateLock = locks.find(\n          (value) => value.lookupName === lookupName\n        );\n        const update: ProviderLockUpdate = {\n          newVersion,\n          newConstraint,\n          newHashes: await TerraformProviderHash.createHashes(\n            registryUrl,\n            lookupName,\n            newVersion\n          ),\n          ...updateLock,\n        };\n        updates.push(update);\n      }\n    }\n    // if no updates have been found or there are failed hashes abort\n    if (updates.length === 0 || updates.some((value) => !value.newHashes)) {\n      return null;\n    }\n\n    const res = writeLockUpdates(updates, lockFilePath, lockFileContent);\n    return res ? [res] : null;\n  } catch (err) {\n    /* istanbul ignore next */\n    return [\n      {\n        artifactError: {\n          lockFile: lockFilePath,\n          stderr: err.message,\n        },\n      },\n    ];\n  }\n}\n"]}