{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../../lib/manager/gradle-wrapper/utils.ts"],"names":[],"mappings":";;;;AACA,yDAAoB;AACpB,+DAA0B;AAC1B,gDAAmD;AACnD,yCAAsC;AACtC,sCAAsC;AACtC,4CAAyC;AACzC,kFAAuD;AACvD,8CAA2D;AAG9C,QAAA,QAAQ,GAAG;IACtB,WAAW,EACT,qHAAqH;CACxH,CAAC;AAEF,SAAgB,qBAAqB;IACnC,IACE,YAAE,CAAC,QAAQ,EAAE,KAAK,OAAO;QACzB,qBAAY,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,QAAQ,EAC7C;QACA,OAAO,aAAa,CAAC;KACtB;IACD,OAAO,WAAW,CAAC;AACrB,CAAC;AARD,sDAQC;AAEM,KAAK,UAAU,oBAAoB,CACxC,WAAmB,EACnB,GAAW,EACX,OAAqB,EACrB,IAAmB;IAEnB,qBAAqB;IACrB,IAAI,CAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,MAAM,EAAE,MAAK,IAAI,EAAE;QAC9B,0CAA0C;QAC1C,IAAI,CAAC,OAAO,CAAC,IAAI,GAAG,GAAG,CAAC,KAAK,CAAC,EAAE;YAC9B,8DAA8D;YAC9D,MAAM,IAAA,UAAK,EAAC,eAAK,CAAC,IAAI,CAAC,GAAG,EAAE,WAAW,CAAC,EAAE,OAAO,CAAC,IAAI,GAAG,KAAK,CAAC,CAAC;SACjE;QACD,IAAI,IAAI,KAAK,IAAI,EAAE;YACjB,OAAO,WAAW,CAAC;SACpB;QACD,OAAO,GAAG,WAAW,IAAI,IAAI,EAAE,CAAC;KACjC;IACD,8BAA8B;IAC9B,OAAO,IAAI,CAAC;AACd,CAAC;AApBD,oDAoBC;AAED;;;;;GAKG;AACH,SAAgB,gBAAgB,CAAC,aAAqB;IACpD,IAAI,qBAAY,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,QAAQ,EAAE;QACjD,SAAS;QACT,OAAO,IAAI,CAAC;KACb;IAED,MAAM,KAAK,GAAG,gBAAgB,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC;IACvD,IAAI,KAAK,IAAI,CAAC,EAAE;QACd,OAAO,SAAS,CAAC;KAClB;IACD,sCAAsC;IACtC,IAAI,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,EAAE;QAC1B,OAAO,QAAQ,CAAC;KACjB;IACD,OAAO,SAAS,CAAC;AACnB,CAAC;AAfD,4CAeC;AAED,SAAgB,iBAAiB;IAC/B,OAAO,QAAa,CAAC;AACvB,CAAC;AAFD,8CAEC;AAED,kCAAkC;AAClC,MAAM,sBAAsB,GAAG,IAAA,aAAK,EAClC,qHAAqH,CACtH,CAAC;AAEF,SAAgB,oBAAoB,CAClC,WAAmB;;IAEnB,MAAM,KAAK,GAAG,MAAA,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,KAAK,CAAC,IAAI,CAAC,mCAAI,EAAE,CAAC;IAE7C,KAAK,MAAM,IAAI,IAAI,KAAK,EAAE;QACxB,MAAM,oBAAoB,GAAG,sBAAsB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAE/D,IAAI,oBAAoB,EAAE;YACxB,OAAO;gBACL,GAAG,EAAE,oBAAoB,CAAC,MAAM,CAAC,GAAG;gBACpC,OAAO,EAAE,oBAAoB,CAAC,MAAM,CAAC,OAAO;aAC7C,CAAC;SACH;KACF;IACD,eAAM,CAAC,KAAK,CACV,yFAAyF,CAC1F,CAAC;IAEF,OAAO,IAAI,CAAC;AACd,CAAC;AApBD,oDAoBC","sourcesContent":["import type { Stats } from 'fs';\nimport os from 'os';\nimport upath from 'upath';\nimport { GlobalConfig } from '../../config/global';\nimport { logger } from '../../logger';\nimport { chmod } from '../../util/fs';\nimport { regEx } from '../../util/regex';\nimport gradleVersioning from '../../versioning/gradle';\nimport { id as npmVersioning } from '../../versioning/npm';\nimport { GradleVersionExtract } from './types';\n\nexport const extraEnv = {\n  GRADLE_OPTS:\n    '-Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true -Dorg.gradle.daemon=false -Dorg.gradle.caching=false',\n};\n\nexport function gradleWrapperFileName(): string {\n  if (\n    os.platform() === 'win32' &&\n    GlobalConfig.get('binarySource') !== 'docker'\n  ) {\n    return 'gradlew.bat';\n  }\n  return './gradlew';\n}\n\nexport async function prepareGradleCommand(\n  gradlewName: string,\n  cwd: string,\n  gradlew: Stats | null,\n  args: string | null\n): Promise<string> {\n  // istanbul ignore if\n  if (gradlew?.isFile() === true) {\n    // if the file is not executable by others\n    if ((gradlew.mode & 0o1) === 0) {\n      // add the execution permission to the owner, group and others\n      await chmod(upath.join(cwd, gradlewName), gradlew.mode | 0o111);\n    }\n    if (args === null) {\n      return gradlewName;\n    }\n    return `${gradlewName} ${args}`;\n  }\n  /* eslint-enable no-bitwise */\n  return null;\n}\n\n/**\n * Find compatible java version for gradle.\n * see https://docs.gradle.org/current/userguide/compatibility.html\n * @param gradleVersion current gradle version\n * @returns A Java semver range\n */\nexport function getJavaContraint(gradleVersion: string): string | null {\n  if (GlobalConfig.get('binarySource') !== 'docker') {\n    // ignore\n    return null;\n  }\n\n  const major = gradleVersioning.getMajor(gradleVersion);\n  if (major >= 7) {\n    return '^16.0.0';\n  }\n  // first public gradle version was 2.0\n  if (major > 0 && major < 5) {\n    return '^8.0.0';\n  }\n  return '^11.0.0';\n}\n\nexport function getJavaVersioning(): string {\n  return npmVersioning;\n}\n\n// https://regex101.com/r/IcOs7P/1\nconst DISTRIBUTION_URL_REGEX = regEx(\n  '^(?:distributionUrl\\\\s*=\\\\s*)(?<url>\\\\S*-(?<version>\\\\d+\\\\.\\\\d+(?:\\\\.\\\\d+)?(?:-\\\\w+)*)-(?<type>bin|all)\\\\.zip)\\\\s*$'\n);\n\nexport function extractGradleVersion(\n  fileContent: string\n): GradleVersionExtract | null {\n  const lines = fileContent?.split('\\n') ?? [];\n\n  for (const line of lines) {\n    const distributionUrlMatch = DISTRIBUTION_URL_REGEX.exec(line);\n\n    if (distributionUrlMatch) {\n      return {\n        url: distributionUrlMatch.groups.url,\n        version: distributionUrlMatch.groups.version,\n      };\n    }\n  }\n  logger.debug(\n    'Gradle wrapper version and url could not be extracted from properties - skipping update'\n  );\n\n  return null;\n}\n"]}