{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../lib/manager/kustomize/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { load } from 'js-yaml';\nimport * as datasourceDocker from '../../datasource/docker';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport * as datasourceGitHubTags from '../../datasource/github-tags';\nimport { HelmDatasource } from '../../datasource/helm';\nimport { logger } from '../../logger';\nimport { SkipReason } from '../../types';\nimport { regEx } from '../../util/regex';\nimport { splitImageParts } from '../dockerfile/extract';\nimport type { PackageDependency, PackageFile } from '../types';\nimport type { HelmChart, Image, Kustomize } from './types';\n\n// URL specifications should follow the hashicorp URL format\n// https://github.com/hashicorp/go-getter#url-format\nconst gitUrl = regEx(\n  /^(?:git::)?(?<url>(?:(?:(?:http|https|ssh):\\/\\/)?(?:.*@)?)?(?<path>(?:[^:/\\s]+(?::[0-9]+)?[:/])?(?<project>[^/\\s]+\\/[^/\\s]+)))(?<subdir>[^?\\s]*)\\?ref=(?<currentValue>.+)$/\n);\n\nexport function extractResource(base: string): PackageDependency | null {\n  const match = gitUrl.exec(base);\n\n  if (!match) {\n    return null;\n  }\n\n  const { path } = match.groups;\n  if (path.startsWith('github.com:') || path.startsWith('github.com/')) {\n    return {\n      currentValue: match.groups.currentValue,\n      datasource: datasourceGitHubTags.id,\n      depName: match.groups.project.replace('.git', ''),\n    };\n  }\n\n  return {\n    datasource: GitTagsDatasource.id,\n    depName: path.replace('.git', ''),\n    lookupName: match.groups.url,\n    currentValue: match.groups.currentValue,\n  };\n}\n\nexport function extractImage(image: Image): PackageDependency | null {\n  if (!image.name) {\n    return null;\n  }\n  const nameDep = splitImageParts(image.newName ?? image.name);\n  const { depName } = nameDep;\n  const { digest, newTag } = image;\n  if (digest && newTag) {\n    logger.warn(\n      { newTag, digest },\n      'Kustomize ignores newTag when digest is provided. Pick one, or use `newTag: tag@digest`'\n    );\n    return {\n      depName,\n      currentValue: newTag,\n      currentDigest: digest,\n      skipReason: SkipReason.InvalidDependencySpecification,\n    };\n  }\n\n  if (digest) {\n    if (!is.string(digest) || !digest.startsWith('sha256:')) {\n      return {\n        depName,\n        currentValue: digest,\n        skipReason: SkipReason.InvalidValue,\n      };\n    }\n\n    return {\n      datasource: datasourceDocker.id,\n      depName,\n      currentValue: nameDep.currentValue,\n      currentDigest: digest,\n      replaceString: digest,\n    };\n  }\n\n  if (newTag) {\n    if (!is.string(newTag) || newTag.startsWith('sha256:')) {\n      return {\n        depName,\n        currentValue: newTag,\n        skipReason: SkipReason.InvalidValue,\n      };\n    }\n\n    const dep = splitImageParts(`${depName}:${newTag}`);\n    return {\n      ...dep,\n      datasource: datasourceDocker.id,\n      replaceString: newTag,\n    };\n  }\n\n  if (image.newName) {\n    return {\n      ...nameDep,\n      datasource: datasourceDocker.id,\n      replaceString: image.newName,\n    };\n  }\n\n  return null;\n}\n\nexport function extractHelmChart(\n  helmChart: HelmChart\n): PackageDependency | null {\n  if (!helmChart.name) {\n    return null;\n  }\n\n  return {\n    depName: helmChart.name,\n    currentValue: helmChart.version,\n    registryUrls: [helmChart.repo],\n    datasource: HelmDatasource.id,\n  };\n}\n\nexport function parseKustomize(content: string): Kustomize | null {\n  let pkg: Kustomize | null = null;\n  try {\n    pkg = load(content, { json: true }) as Kustomize;\n  } catch (e) /* istanbul ignore next */ {\n    return null;\n  }\n\n  if (!pkg) {\n    return null;\n  }\n\n  if (!['Kustomization', 'Component'].includes(pkg.kind)) {\n    return null;\n  }\n\n  return pkg;\n}\n\nexport function extractPackageFile(content: string): PackageFile | null {\n  logger.trace('kustomize.extractPackageFile()');\n  const deps: PackageDependency[] = [];\n\n  const pkg = parseKustomize(content);\n  if (!pkg) {\n    return null;\n  }\n\n  // grab the remote bases\n  for (const base of pkg.bases ?? []) {\n    const dep = extractResource(base);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the remote resources\n  for (const resource of pkg.resources ?? []) {\n    const dep = extractResource(resource);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the remote components\n  for (const component of pkg.components ?? []) {\n    const dep = extractResource(component);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the image tags\n  for (const image of pkg.images ?? []) {\n    const dep = extractImage(image);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: pkg.kind,\n      });\n    }\n  }\n\n  // grab the helm charts\n  for (const helmChart of pkg.helmCharts ?? []) {\n    const dep = extractHelmChart(helmChart);\n    if (dep) {\n      deps.push({\n        ...dep,\n        depType: 'HelmChart',\n      });\n    }\n  }\n\n  if (!deps.length) {\n    return null;\n  }\n  return { deps };\n}\n"]}