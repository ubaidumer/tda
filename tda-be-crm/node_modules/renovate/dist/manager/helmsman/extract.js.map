{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../lib/manager/helmsman/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { load } from 'js-yaml';\nimport { HelmDatasource } from '../../datasource/helm';\nimport { logger } from '../../logger';\nimport { SkipReason } from '../../types';\nimport { regEx } from '../../util/regex';\nimport type { ExtractConfig, PackageDependency, PackageFile } from '../types';\nimport type { HelmsmanDocument } from './types';\n\nconst chartRegex = regEx('^(?<registryRef>[^/]*)/(?<lookupName>[^/]*)$');\n\nfunction createDep(key: string, doc: HelmsmanDocument): PackageDependency {\n  const dep: PackageDependency = {\n    depName: key,\n    datasource: HelmDatasource.id,\n  };\n  const anApp = doc.apps[key];\n  if (!anApp) {\n    return null;\n  }\n\n  if (!anApp.version) {\n    dep.skipReason = SkipReason.NoVersion;\n    return dep;\n  }\n  dep.currentValue = anApp.version;\n\n  const regexResult = chartRegex.exec(anApp.chart);\n  if (!regexResult) {\n    dep.skipReason = SkipReason.InvalidUrl;\n    return dep;\n  }\n\n  if (!is.nonEmptyString(regexResult.groups.lookupName)) {\n    dep.skipReason = SkipReason.InvalidName;\n    return dep;\n  }\n  dep.lookupName = regexResult.groups.lookupName;\n\n  const registryUrl = doc.helmRepos[regexResult.groups.registryRef];\n  if (!is.nonEmptyString(registryUrl)) {\n    dep.skipReason = SkipReason.NoRepository;\n    return dep;\n  }\n  dep.registryUrls = [registryUrl];\n\n  return dep;\n}\n\nexport function extractPackageFile(\n  content: string,\n  fileName: string,\n  config: ExtractConfig\n): PackageFile | null {\n  try {\n    // TODO: fix me (#9610)\n    const doc = load(content, {\n      json: true,\n    }) as HelmsmanDocument;\n    if (!(doc?.helmRepos && doc.apps)) {\n      logger.debug({ fileName }, 'Missing helmRepos and/or apps keys');\n      return null;\n    }\n\n    const deps = Object.keys(doc.apps)\n      .map((key) => createDep(key, doc))\n      .filter(Boolean); // filter null values\n\n    if (deps.length === 0) {\n      return null;\n    }\n\n    return { deps };\n  } catch (err) /* istanbul ignore next */ {\n    if (err.stack?.startsWith('YAMLException:')) {\n      logger.debug({ err }, 'YAML exception extracting');\n    } else {\n      logger.warn({ err }, 'Error extracting');\n    }\n    return null;\n  }\n}\n"]}